{"ast":null,"code":"import initDebug from 'debug';\nimport { BasicParser } from '../../common/BasicParser.js';\nimport { tryParseApeHeader } from '../../apev2/APEv2Parser.js';\nimport { FourCcToken } from '../../common/FourCC.js';\nimport * as SV8 from './StreamVersion8.js';\nimport { MusepackContentError } from '../MusepackConentError.js';\nconst debug = initDebug('music-metadata:parser:musepack');\nexport class MpcSv8Parser extends BasicParser {\n  constructor() {\n    super(...arguments);\n    this.audioLength = 0;\n  }\n  async parse() {\n    const signature = await this.tokenizer.readToken(FourCcToken);\n    if (signature !== 'MPCK') throw new MusepackContentError('Invalid Magic number');\n    this.metadata.setFormat('container', 'Musepack, SV8');\n    return this.parsePacket();\n  }\n  async parsePacket() {\n    const sv8reader = new SV8.StreamReader(this.tokenizer);\n    do {\n      const header = await sv8reader.readPacketHeader();\n      debug(`packet-header key=${header.key}, payloadLength=${header.payloadLength}`);\n      switch (header.key) {\n        case 'SH':\n          {\n            // Stream Header\n            const sh = await sv8reader.readStreamHeader(header.payloadLength);\n            this.metadata.setFormat('numberOfSamples', sh.sampleCount);\n            this.metadata.setFormat('sampleRate', sh.sampleFrequency);\n            this.metadata.setFormat('duration', sh.sampleCount / sh.sampleFrequency);\n            this.metadata.setFormat('numberOfChannels', sh.channelCount);\n            break;\n          }\n        case 'AP':\n          // Audio Packet\n          this.audioLength += header.payloadLength;\n          await this.tokenizer.ignore(header.payloadLength);\n          break;\n        case 'RG': // Replaygain\n        case 'EI': // Encoder Info\n        case 'SO': // Seek Table Offset\n        case 'ST': // Seek Table\n        case 'CT':\n          // Chapter-Tag\n          await this.tokenizer.ignore(header.payloadLength);\n          break;\n        case 'SE':\n          // Stream End\n          if (this.metadata.format.duration) {\n            this.metadata.setFormat('bitrate', this.audioLength * 8 / this.metadata.format.duration);\n          }\n          return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\n        default:\n          throw new MusepackContentError(`Unexpected header: ${header.key}`);\n      }\n      // biome-ignore lint/correctness/noConstantCondition: break is handled in the switch statement\n    } while (true);\n  }\n}","map":{"version":3,"names":["initDebug","BasicParser","tryParseApeHeader","FourCcToken","SV8","MusepackContentError","debug","MpcSv8Parser","constructor","arguments","audioLength","parse","signature","tokenizer","readToken","metadata","setFormat","parsePacket","sv8reader","StreamReader","header","readPacketHeader","key","payloadLength","sh","readStreamHeader","sampleCount","sampleFrequency","channelCount","ignore","format","duration","options"],"sources":["C:/projects/My projects/Vue/osi/node_modules/music-metadata/lib/musepack/sv8/MpcSv8Parser.js"],"sourcesContent":["import initDebug from 'debug';\r\nimport { BasicParser } from '../../common/BasicParser.js';\r\nimport { tryParseApeHeader } from '../../apev2/APEv2Parser.js';\r\nimport { FourCcToken } from '../../common/FourCC.js';\r\nimport * as SV8 from './StreamVersion8.js';\r\nimport { MusepackContentError } from '../MusepackConentError.js';\r\nconst debug = initDebug('music-metadata:parser:musepack');\r\nexport class MpcSv8Parser extends BasicParser {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.audioLength = 0;\r\n    }\r\n    async parse() {\r\n        const signature = await this.tokenizer.readToken(FourCcToken);\r\n        if (signature !== 'MPCK')\r\n            throw new MusepackContentError('Invalid Magic number');\r\n        this.metadata.setFormat('container', 'Musepack, SV8');\r\n        return this.parsePacket();\r\n    }\r\n    async parsePacket() {\r\n        const sv8reader = new SV8.StreamReader(this.tokenizer);\r\n        do {\r\n            const header = await sv8reader.readPacketHeader();\r\n            debug(`packet-header key=${header.key}, payloadLength=${header.payloadLength}`);\r\n            switch (header.key) {\r\n                case 'SH': { // Stream Header\r\n                    const sh = await sv8reader.readStreamHeader(header.payloadLength);\r\n                    this.metadata.setFormat('numberOfSamples', sh.sampleCount);\r\n                    this.metadata.setFormat('sampleRate', sh.sampleFrequency);\r\n                    this.metadata.setFormat('duration', sh.sampleCount / sh.sampleFrequency);\r\n                    this.metadata.setFormat('numberOfChannels', sh.channelCount);\r\n                    break;\r\n                }\r\n                case 'AP': // Audio Packet\r\n                    this.audioLength += header.payloadLength;\r\n                    await this.tokenizer.ignore(header.payloadLength);\r\n                    break;\r\n                case 'RG': // Replaygain\r\n                case 'EI': // Encoder Info\r\n                case 'SO': // Seek Table Offset\r\n                case 'ST': // Seek Table\r\n                case 'CT': // Chapter-Tag\r\n                    await this.tokenizer.ignore(header.payloadLength);\r\n                    break;\r\n                case 'SE': // Stream End\r\n                    if (this.metadata.format.duration) {\r\n                        this.metadata.setFormat('bitrate', this.audioLength * 8 / this.metadata.format.duration);\r\n                    }\r\n                    return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\r\n                default:\r\n                    throw new MusepackContentError(`Unexpected header: ${header.key}`);\r\n            }\r\n            // biome-ignore lint/correctness/noConstantCondition: break is handled in the switch statement\r\n        } while (true);\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}