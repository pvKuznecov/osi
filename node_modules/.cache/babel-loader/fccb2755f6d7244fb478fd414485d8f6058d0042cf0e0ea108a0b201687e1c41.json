{"ast":null,"code":"import initDebug from 'debug';\nimport { BasicParser } from '../../common/BasicParser.js';\nimport { tryParseApeHeader } from '../../apev2/APEv2Parser.js';\nimport { BitReader } from './BitReader.js';\nimport * as SV7 from './StreamVersion7.js';\nimport { MusepackContentError } from '../MusepackConentError.js';\nconst debug = initDebug('music-metadata:parser:musepack');\nexport class MpcSv7Parser extends BasicParser {\n  constructor() {\n    super(...arguments);\n    this.bitreader = null;\n    this.audioLength = 0;\n    this.duration = null;\n  }\n  async parse() {\n    const header = await this.tokenizer.readToken(SV7.Header);\n    if (header.signature !== 'MP+') throw new MusepackContentError('Unexpected magic number');\n    debug(`stream-version=${header.streamMajorVersion}.${header.streamMinorVersion}`);\n    this.metadata.setFormat('container', 'Musepack, SV7');\n    this.metadata.setFormat('sampleRate', header.sampleFrequency);\n    const numberOfSamples = 1152 * (header.frameCount - 1) + header.lastFrameLength;\n    this.metadata.setFormat('numberOfSamples', numberOfSamples);\n    this.duration = numberOfSamples / header.sampleFrequency;\n    this.metadata.setFormat('duration', this.duration);\n    this.bitreader = new BitReader(this.tokenizer);\n    this.metadata.setFormat('numberOfChannels', header.midSideStereo || header.intensityStereo ? 2 : 1);\n    const version = await this.bitreader.read(8);\n    this.metadata.setFormat('codec', (version / 100).toFixed(2));\n    await this.skipAudioData(header.frameCount);\n    debug(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`);\n    return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\n  }\n  async skipAudioData(frameCount) {\n    while (frameCount-- > 0) {\n      const frameLength = await this.bitreader.read(20);\n      this.audioLength += 20 + frameLength;\n      await this.bitreader.ignore(frameLength);\n    }\n    // last frame\n    const lastFrameLength = await this.bitreader.read(11);\n    this.audioLength += lastFrameLength;\n    if (this.duration !== null) {\n      this.metadata.setFormat('bitrate', this.audioLength / this.duration);\n    }\n  }\n}","map":{"version":3,"names":["initDebug","BasicParser","tryParseApeHeader","BitReader","SV7","MusepackContentError","debug","MpcSv7Parser","constructor","arguments","bitreader","audioLength","duration","parse","header","tokenizer","readToken","Header","signature","streamMajorVersion","streamMinorVersion","metadata","setFormat","sampleFrequency","numberOfSamples","frameCount","lastFrameLength","midSideStereo","intensityStereo","version","read","toFixed","skipAudioData","position","options","frameLength","ignore"],"sources":["C:/projects/My projects/Vue/osi/node_modules/music-metadata/lib/musepack/sv7/MpcSv7Parser.js"],"sourcesContent":["import initDebug from 'debug';\r\nimport { BasicParser } from '../../common/BasicParser.js';\r\nimport { tryParseApeHeader } from '../../apev2/APEv2Parser.js';\r\nimport { BitReader } from './BitReader.js';\r\nimport * as SV7 from './StreamVersion7.js';\r\nimport { MusepackContentError } from '../MusepackConentError.js';\r\nconst debug = initDebug('music-metadata:parser:musepack');\r\nexport class MpcSv7Parser extends BasicParser {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.bitreader = null;\r\n        this.audioLength = 0;\r\n        this.duration = null;\r\n    }\r\n    async parse() {\r\n        const header = await this.tokenizer.readToken(SV7.Header);\r\n        if (header.signature !== 'MP+')\r\n            throw new MusepackContentError('Unexpected magic number');\r\n        debug(`stream-version=${header.streamMajorVersion}.${header.streamMinorVersion}`);\r\n        this.metadata.setFormat('container', 'Musepack, SV7');\r\n        this.metadata.setFormat('sampleRate', header.sampleFrequency);\r\n        const numberOfSamples = 1152 * (header.frameCount - 1) + header.lastFrameLength;\r\n        this.metadata.setFormat('numberOfSamples', numberOfSamples);\r\n        this.duration = numberOfSamples / header.sampleFrequency;\r\n        this.metadata.setFormat('duration', this.duration);\r\n        this.bitreader = new BitReader(this.tokenizer);\r\n        this.metadata.setFormat('numberOfChannels', header.midSideStereo || header.intensityStereo ? 2 : 1);\r\n        const version = await this.bitreader.read(8);\r\n        this.metadata.setFormat('codec', (version / 100).toFixed(2));\r\n        await this.skipAudioData(header.frameCount);\r\n        debug(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`);\r\n        return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\r\n    }\r\n    async skipAudioData(frameCount) {\r\n        while (frameCount-- > 0) {\r\n            const frameLength = await this.bitreader.read(20);\r\n            this.audioLength += 20 + frameLength;\r\n            await this.bitreader.ignore(frameLength);\r\n        }\r\n        // last frame\r\n        const lastFrameLength = await this.bitreader.read(11);\r\n        this.audioLength += lastFrameLength;\r\n        if (this.duration !== null) {\r\n            this.metadata.setFormat('bitrate', this.audioLength / this.duration);\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}