{"ast":null,"code":"import * as Token from 'token-types';\nimport initDebug from 'debug';\nimport * as util from '../../common/Util.js';\nconst debug = initDebug('music-metadata:parser:musepack:sv8');\nconst PacketKey = new Token.StringType(2, 'latin1');\n/**\r\n * Stream Header Packet part 1\r\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\r\n */\nconst SH_part1 = {\n  len: 5,\n  get: (buf, off) => {\n    return {\n      crc: Token.UINT32_LE.get(buf, off),\n      streamVersion: Token.UINT8.get(buf, off + 4)\n    };\n  }\n};\n/**\r\n * Stream Header Packet part 3\r\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\r\n */\nconst SH_part3 = {\n  len: 2,\n  get: (buf, off) => {\n    return {\n      sampleFrequency: [44100, 48000, 37800, 32000][util.getBitAllignedNumber(buf, off, 0, 3)],\n      maxUsedBands: util.getBitAllignedNumber(buf, off, 3, 5),\n      channelCount: util.getBitAllignedNumber(buf, off + 1, 0, 4) + 1,\n      msUsed: util.isBitSet(buf, off + 1, 4),\n      audioBlockFrames: util.getBitAllignedNumber(buf, off + 1, 5, 3)\n    };\n  }\n};\nexport class StreamReader {\n  get tokenizer() {\n    return this._tokenizer;\n  }\n  set tokenizer(value) {\n    this._tokenizer = value;\n  }\n  constructor(_tokenizer) {\n    this._tokenizer = _tokenizer;\n  }\n  async readPacketHeader() {\n    const key = await this.tokenizer.readToken(PacketKey);\n    const size = await this.readVariableSizeField();\n    return {\n      key,\n      payloadLength: size.value - 2 - size.len\n    };\n  }\n  async readStreamHeader(size) {\n    const streamHeader = {};\n    debug(`Reading SH at offset=${this.tokenizer.position}`);\n    const part1 = await this.tokenizer.readToken(SH_part1);\n    size -= SH_part1.len;\n    Object.assign(streamHeader, part1);\n    debug(`SH.streamVersion = ${part1.streamVersion}`);\n    const sampleCount = await this.readVariableSizeField();\n    size -= sampleCount.len;\n    streamHeader.sampleCount = sampleCount.value;\n    const bs = await this.readVariableSizeField();\n    size -= bs.len;\n    streamHeader.beginningOfSilence = bs.value;\n    const part3 = await this.tokenizer.readToken(SH_part3);\n    size -= SH_part3.len;\n    Object.assign(streamHeader, part3);\n    // assert.equal(size, 0);\n    await this.tokenizer.ignore(size);\n    return streamHeader;\n  }\n  async readVariableSizeField(len = 1, hb = 0) {\n    let n = await this.tokenizer.readNumber(Token.UINT8);\n    if ((n & 0x80) === 0) {\n      return {\n        len,\n        value: hb + n\n      };\n    }\n    n &= 0x7F;\n    n += hb;\n    return this.readVariableSizeField(len + 1, n << 7);\n  }\n}","map":{"version":3,"names":["Token","initDebug","util","debug","PacketKey","StringType","SH_part1","len","get","buf","off","crc","UINT32_LE","streamVersion","UINT8","SH_part3","sampleFrequency","getBitAllignedNumber","maxUsedBands","channelCount","msUsed","isBitSet","audioBlockFrames","StreamReader","tokenizer","_tokenizer","value","constructor","readPacketHeader","key","readToken","size","readVariableSizeField","payloadLength","readStreamHeader","streamHeader","position","part1","Object","assign","sampleCount","bs","beginningOfSilence","part3","ignore","hb","n","readNumber"],"sources":["C:/projects/My projects/Vue/osi/node_modules/music-metadata/lib/musepack/sv8/StreamVersion8.js"],"sourcesContent":["import * as Token from 'token-types';\r\nimport initDebug from 'debug';\r\nimport * as util from '../../common/Util.js';\r\nconst debug = initDebug('music-metadata:parser:musepack:sv8');\r\nconst PacketKey = new Token.StringType(2, 'latin1');\r\n/**\r\n * Stream Header Packet part 1\r\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\r\n */\r\nconst SH_part1 = {\r\n    len: 5,\r\n    get: (buf, off) => {\r\n        return {\r\n            crc: Token.UINT32_LE.get(buf, off),\r\n            streamVersion: Token.UINT8.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Stream Header Packet part 3\r\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\r\n */\r\nconst SH_part3 = {\r\n    len: 2,\r\n    get: (buf, off) => {\r\n        return {\r\n            sampleFrequency: [44100, 48000, 37800, 32000][util.getBitAllignedNumber(buf, off, 0, 3)],\r\n            maxUsedBands: util.getBitAllignedNumber(buf, off, 3, 5),\r\n            channelCount: util.getBitAllignedNumber(buf, off + 1, 0, 4) + 1,\r\n            msUsed: util.isBitSet(buf, off + 1, 4),\r\n            audioBlockFrames: util.getBitAllignedNumber(buf, off + 1, 5, 3)\r\n        };\r\n    }\r\n};\r\nexport class StreamReader {\r\n    get tokenizer() {\r\n        return this._tokenizer;\r\n    }\r\n    set tokenizer(value) {\r\n        this._tokenizer = value;\r\n    }\r\n    constructor(_tokenizer) {\r\n        this._tokenizer = _tokenizer;\r\n    }\r\n    async readPacketHeader() {\r\n        const key = await this.tokenizer.readToken(PacketKey);\r\n        const size = await this.readVariableSizeField();\r\n        return {\r\n            key,\r\n            payloadLength: size.value - 2 - size.len\r\n        };\r\n    }\r\n    async readStreamHeader(size) {\r\n        const streamHeader = {};\r\n        debug(`Reading SH at offset=${this.tokenizer.position}`);\r\n        const part1 = await this.tokenizer.readToken(SH_part1);\r\n        size -= SH_part1.len;\r\n        Object.assign(streamHeader, part1);\r\n        debug(`SH.streamVersion = ${part1.streamVersion}`);\r\n        const sampleCount = await this.readVariableSizeField();\r\n        size -= sampleCount.len;\r\n        streamHeader.sampleCount = sampleCount.value;\r\n        const bs = await this.readVariableSizeField();\r\n        size -= bs.len;\r\n        streamHeader.beginningOfSilence = bs.value;\r\n        const part3 = await this.tokenizer.readToken(SH_part3);\r\n        size -= SH_part3.len;\r\n        Object.assign(streamHeader, part3);\r\n        // assert.equal(size, 0);\r\n        await this.tokenizer.ignore(size);\r\n        return streamHeader;\r\n    }\r\n    async readVariableSizeField(len = 1, hb = 0) {\r\n        let n = await this.tokenizer.readNumber(Token.UINT8);\r\n        if ((n & 0x80) === 0) {\r\n            return { len, value: hb + n };\r\n        }\r\n        n &= 0x7F;\r\n        n += hb;\r\n        return this.readVariableSizeField(len + 1, n << 7);\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}