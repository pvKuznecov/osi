{"ast":null,"code":"import * as Token from 'token-types';\nimport { VorbisStream } from '../vorbis/VorbisStream.js';\nimport * as Opus from './Opus.js';\nimport { OpusContentError } from './Opus.js';\n/**\n * Opus parser\n * Internet Engineering Task Force (IETF) - RFC 6716\n * Used by OggStream\n */\nexport class OpusStream extends VorbisStream {\n  constructor(metadata, options, tokenizer) {\n    super(metadata, options);\n    this.idHeader = null;\n    this.lastPos = -1;\n    this.tokenizer = tokenizer;\n    this.durationOnLastPage = true;\n  }\n  /**\n   * Parse first Opus Ogg page\n   * @param {IPageHeader} header\n   * @param {Uint8Array} pageData\n   */\n  parseFirstPage(_header, pageData) {\n    this.metadata.setFormat('codec', 'Opus');\n    // Parse Opus ID Header\n    this.idHeader = new Opus.IdHeader(pageData.length).get(pageData, 0);\n    if (this.idHeader.magicSignature !== \"OpusHead\") throw new OpusContentError(\"Illegal ogg/Opus magic-signature\");\n    this.metadata.setFormat('sampleRate', this.idHeader.inputSampleRate);\n    this.metadata.setFormat('numberOfChannels', this.idHeader.channelCount);\n    this.metadata.setAudioOnly();\n  }\n  async parseFullPage(pageData) {\n    const magicSignature = new Token.StringType(8, 'ascii').get(pageData, 0);\n    switch (magicSignature) {\n      case 'OpusTags':\n        await this.parseUserCommentList(pageData, 8);\n        this.lastPos = this.tokenizer.position - pageData.length;\n        break;\n      default:\n        break;\n    }\n  }\n  calculateDuration(enfOfStream) {\n    if (this.lastPageHeader && (enfOfStream || this.lastPageHeader.headerType.lastPage) && this.metadata.format.sampleRate && this.lastPageHeader.absoluteGranulePosition >= 0) {\n      // Calculate duration\n      const pos_48bit = this.lastPageHeader.absoluteGranulePosition - this.idHeader.preSkip;\n      this.metadata.setFormat('numberOfSamples', pos_48bit);\n      this.metadata.setFormat('duration', pos_48bit / 48000);\n      if (this.lastPos !== -1 && this.tokenizer.fileInfo.size && this.metadata.format.duration) {\n        const dataSize = this.tokenizer.fileInfo.size - this.lastPos;\n        this.metadata.setFormat('bitrate', 8 * dataSize / this.metadata.format.duration);\n      }\n    }\n  }\n}","map":{"version":3,"names":["Token","VorbisStream","Opus","OpusContentError","OpusStream","constructor","metadata","options","tokenizer","idHeader","lastPos","durationOnLastPage","parseFirstPage","_header","pageData","setFormat","IdHeader","length","get","magicSignature","inputSampleRate","channelCount","setAudioOnly","parseFullPage","StringType","parseUserCommentList","position","calculateDuration","enfOfStream","lastPageHeader","headerType","lastPage","format","sampleRate","absoluteGranulePosition","pos_48bit","preSkip","fileInfo","size","duration","dataSize"],"sources":["/home/kup/my_projects/vue/osi/node_modules/music-metadata/lib/ogg/opus/OpusStream.js"],"sourcesContent":["import * as Token from 'token-types';\nimport { VorbisStream } from '../vorbis/VorbisStream.js';\nimport * as Opus from './Opus.js';\nimport { OpusContentError } from './Opus.js';\n/**\n * Opus parser\n * Internet Engineering Task Force (IETF) - RFC 6716\n * Used by OggStream\n */\nexport class OpusStream extends VorbisStream {\n    constructor(metadata, options, tokenizer) {\n        super(metadata, options);\n        this.idHeader = null;\n        this.lastPos = -1;\n        this.tokenizer = tokenizer;\n        this.durationOnLastPage = true;\n    }\n    /**\n     * Parse first Opus Ogg page\n     * @param {IPageHeader} header\n     * @param {Uint8Array} pageData\n     */\n    parseFirstPage(_header, pageData) {\n        this.metadata.setFormat('codec', 'Opus');\n        // Parse Opus ID Header\n        this.idHeader = new Opus.IdHeader(pageData.length).get(pageData, 0);\n        if (this.idHeader.magicSignature !== \"OpusHead\")\n            throw new OpusContentError(\"Illegal ogg/Opus magic-signature\");\n        this.metadata.setFormat('sampleRate', this.idHeader.inputSampleRate);\n        this.metadata.setFormat('numberOfChannels', this.idHeader.channelCount);\n        this.metadata.setAudioOnly();\n    }\n    async parseFullPage(pageData) {\n        const magicSignature = new Token.StringType(8, 'ascii').get(pageData, 0);\n        switch (magicSignature) {\n            case 'OpusTags':\n                await this.parseUserCommentList(pageData, 8);\n                this.lastPos = this.tokenizer.position - pageData.length;\n                break;\n            default:\n                break;\n        }\n    }\n    calculateDuration(enfOfStream) {\n        if (this.lastPageHeader && (enfOfStream || this.lastPageHeader.headerType.lastPage) && this.metadata.format.sampleRate && this.lastPageHeader.absoluteGranulePosition >= 0) {\n            // Calculate duration\n            const pos_48bit = this.lastPageHeader.absoluteGranulePosition - this.idHeader.preSkip;\n            this.metadata.setFormat('numberOfSamples', pos_48bit);\n            this.metadata.setFormat('duration', pos_48bit / 48000);\n            if (this.lastPos !== -1 && this.tokenizer.fileInfo.size && this.metadata.format.duration) {\n                const dataSize = this.tokenizer.fileInfo.size - this.lastPos;\n                this.metadata.setFormat('bitrate', 8 * dataSize / this.metadata.format.duration);\n            }\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}