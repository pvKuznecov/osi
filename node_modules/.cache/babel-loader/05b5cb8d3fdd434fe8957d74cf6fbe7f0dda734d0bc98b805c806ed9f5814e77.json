{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport initDebug from 'debug';\nimport * as AtomToken from './AtomToken.js';\nimport { Header } from './AtomToken.js';\nconst debug = initDebug('music-metadata:parser:MP4:Atom');\nexport class Atom {\n  static async readAtom(tokenizer, dataHandler, parent, remaining) {\n    // Parse atom header\n    const offset = tokenizer.position;\n    debug(`Reading next token on offset=${offset}...`); //  buf.toString('ascii')\n    const header = await tokenizer.readToken(AtomToken.Header);\n    const extended = header.length === 1n;\n    if (extended) {\n      header.length = await tokenizer.readToken(AtomToken.ExtendedSize);\n    }\n    const atomBean = new Atom(header, extended, parent);\n    const payloadLength = atomBean.getPayloadLength(remaining);\n    debug(`parse atom name=${atomBean.atomPath}, extended=${atomBean.extended}, offset=${offset}, len=${atomBean.header.length}`); //  buf.toString('ascii')\n    await atomBean.readData(tokenizer, dataHandler, payloadLength);\n    return atomBean;\n  }\n  constructor(header, extended, parent) {\n    this.header = header;\n    this.extended = extended;\n    this.parent = parent;\n    this.children = [];\n    this.atomPath = (this.parent ? `${this.parent.atomPath}.` : '') + this.header.name;\n  }\n  getHeaderLength() {\n    return this.extended ? 16 : 8;\n  }\n  getPayloadLength(remaining) {\n    return (this.header.length === 0n ? remaining : Number(this.header.length)) - this.getHeaderLength();\n  }\n  async readAtoms(tokenizer, dataHandler, size) {\n    while (size > 0) {\n      const atomBean = await Atom.readAtom(tokenizer, dataHandler, this, size);\n      this.children.push(atomBean);\n      size -= atomBean.header.length === 0n ? size : Number(atomBean.header.length);\n    }\n  }\n  async readData(tokenizer, dataHandler, remaining) {\n    switch (this.header.name) {\n      // \"Container\" atoms, contains nested atoms\n      case 'moov': // The Movie Atom: contains other atoms\n      case 'udta': // User defined atom\n      case 'mdia': // Media atom\n      case 'minf': // Media Information Atom\n      case 'stbl': // The Sample Table Atom\n      case '<id>':\n      case 'ilst':\n      case 'tref':\n      case 'moof':\n        return this.readAtoms(tokenizer, dataHandler, this.getPayloadLength(remaining));\n      case 'meta':\n        {\n          // Metadata Atom, ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/Metadata/Metadata.html#//apple_ref/doc/uid/TP40000939-CH1-SW8\n          // meta has 4 bytes of padding, ignore\n          const peekHeader = await tokenizer.peekToken(Header);\n          const paddingLength = peekHeader.name === 'hdlr' ? 0 : 4;\n          await tokenizer.ignore(paddingLength);\n          return this.readAtoms(tokenizer, dataHandler, this.getPayloadLength(remaining) - paddingLength);\n        }\n      default:\n        return dataHandler(this, remaining);\n    }\n  }\n}","map":{"version":3,"names":["initDebug","AtomToken","Header","debug","Atom","readAtom","tokenizer","dataHandler","parent","remaining","offset","position","header","readToken","extended","length","ExtendedSize","atomBean","payloadLength","getPayloadLength","atomPath","readData","constructor","children","name","getHeaderLength","Number","readAtoms","size","push","peekHeader","peekToken","paddingLength","ignore"],"sources":["/home/kup/my_projects/vue/osi/node_modules/music-metadata/lib/mp4/Atom.js"],"sourcesContent":["import initDebug from 'debug';\nimport * as AtomToken from './AtomToken.js';\nimport { Header } from './AtomToken.js';\nconst debug = initDebug('music-metadata:parser:MP4:Atom');\nexport class Atom {\n    static async readAtom(tokenizer, dataHandler, parent, remaining) {\n        // Parse atom header\n        const offset = tokenizer.position;\n        debug(`Reading next token on offset=${offset}...`); //  buf.toString('ascii')\n        const header = await tokenizer.readToken(AtomToken.Header);\n        const extended = header.length === 1n;\n        if (extended) {\n            header.length = await tokenizer.readToken(AtomToken.ExtendedSize);\n        }\n        const atomBean = new Atom(header, extended, parent);\n        const payloadLength = atomBean.getPayloadLength(remaining);\n        debug(`parse atom name=${atomBean.atomPath}, extended=${atomBean.extended}, offset=${offset}, len=${atomBean.header.length}`); //  buf.toString('ascii')\n        await atomBean.readData(tokenizer, dataHandler, payloadLength);\n        return atomBean;\n    }\n    constructor(header, extended, parent) {\n        this.header = header;\n        this.extended = extended;\n        this.parent = parent;\n        this.children = [];\n        this.atomPath = (this.parent ? `${this.parent.atomPath}.` : '') + this.header.name;\n    }\n    getHeaderLength() {\n        return this.extended ? 16 : 8;\n    }\n    getPayloadLength(remaining) {\n        return (this.header.length === 0n ? remaining : Number(this.header.length)) - this.getHeaderLength();\n    }\n    async readAtoms(tokenizer, dataHandler, size) {\n        while (size > 0) {\n            const atomBean = await Atom.readAtom(tokenizer, dataHandler, this, size);\n            this.children.push(atomBean);\n            size -= atomBean.header.length === 0n ? size : Number(atomBean.header.length);\n        }\n    }\n    async readData(tokenizer, dataHandler, remaining) {\n        switch (this.header.name) {\n            // \"Container\" atoms, contains nested atoms\n            case 'moov': // The Movie Atom: contains other atoms\n            case 'udta': // User defined atom\n            case 'mdia': // Media atom\n            case 'minf': // Media Information Atom\n            case 'stbl': // The Sample Table Atom\n            case '<id>':\n            case 'ilst':\n            case 'tref':\n            case 'moof':\n                return this.readAtoms(tokenizer, dataHandler, this.getPayloadLength(remaining));\n            case 'meta': { // Metadata Atom, ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/Metadata/Metadata.html#//apple_ref/doc/uid/TP40000939-CH1-SW8\n                // meta has 4 bytes of padding, ignore\n                const peekHeader = await tokenizer.peekToken(Header);\n                const paddingLength = peekHeader.name === 'hdlr' ? 0 : 4;\n                await tokenizer.ignore(paddingLength);\n                return this.readAtoms(tokenizer, dataHandler, this.getPayloadLength(remaining) - paddingLength);\n            }\n            default:\n                return dataHandler(this, remaining);\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}