{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport \"core-js/modules/es.iterator.to-array.js\";\nimport \"core-js/modules/es.json.stringify.js\";\nimport \"core-js/modules/esnext.json.parse.js\";\nimport Dexie from \"dexie\";\nimport { ref } from \"vue\";\nimport { appsConfig } from \"@/config/applications\";\n\n// конфигураторы БД\nconst db_name = 'OSIDB';\nconst db_version = 1;\n\n// инициализация БД\nconst DB = new Dexie(db_name);\n\n// const defaultApps = await appsConfig.getAllApps();\n// Функция для получения упрощенных объектов приложений\nasync function getDefaultApps() {\n  const apps = await appsConfig.getAllApps();\n\n  // Преобразуем каждый объект приложения в упрощенную версию\n  return apps.map(app => ({\n    id: app.id,\n    name: app.name,\n    label: app.label,\n    category: app.category || 'Other',\n    icon: app.icon || '',\n    iconclass: app.iconclass || '',\n    description: app.description || '',\n    defWidth: app.defWidth || false,\n    defHeight: app.defHeight || false,\n    isMaximized: app.isMaximized || false,\n    resizable: app.resizable || false,\n    canMinimize: app.canMinimize || false,\n    showOnDesktop: app.showOnDesktop || false,\n    showInStartMenu: app.showInStartMenu || false,\n    // Сохраняем только базовые данные, удаляем функции и компоненты\n    path: app.path || '',\n    component: app.component && app.component.name ? app.component.name : 'Component',\n    // Добавляем только примитивные типы данных\n    data: app.data && typeof app.data === 'object' ? JSON.parse(JSON.stringify(app.data)) : {}\n  }));\n}\n\n// описание схемы БД\nDB.version(db_version).stores({\n  users: '++id, name, login, password, apps, data, config, systemconfig, systemdata, createdAt, updatedAt',\n  settings: '++id, key, value, updatedAt'\n});\n\n// ========Default configs========\nconst Def_userConfig = {\n  avatar: \"cat.jpg\"\n};\nconst Def_userSystemconfig = {\n  desktopWallpaper: \"nwall.jpg\",\n  windows: [],\n  activeWindowId: null\n};\nconst Def_systemdata = {\n  windowsstates: []\n};\nlet nextZIndex = 100;\nconst IDBWindows = ref([]);\nconst activeWindowId = ref(null);\nfunction getRandomPosPixel() {\n  const min = Math.ceil(50); // Округляем минимум вверх\n  const max = Math.floor(200); // Округляем максимум вниз\n\n  return Math.floor(Math.random() * (max - min + 1)) + min;\n}\n\n// -=-=-=-=-=-=-Описание классов моделей-=-=-=-=-=-=-\nexport class User {\n  constructor(data = {}) {\n    this.login = data.login || 'user';\n    this.name = data.name || 'User';\n    this.password = data.password || ''; //TODO ПРОДУМАТЬ РЕАЛЬНУЮ СХЕМУ ЗАЩИТЫ\n    this.apps = data.apps || [];\n    this.data = data.data || {};\n    this.config = data.config || Def_userConfig;\n    this.systemconfig = data.systemconfig || Def_userSystemconfig;\n    this.systemdata = data.systemdata || Def_systemdata;\n    this.createdAt = data.createdAt || new Date();\n    this.updatedAt = data.updatedAt || new Date();\n    // автоматическое присваение id (вариант для \"совместимости\")\n    if (data.id) this.id = data.id;\n  }\n}\nexport class Setting {\n  constructor(key, value) {\n    this.key = key;\n    this.value = value;\n    this.updatedAt = new Date();\n  }\n}\nexport class WindowState {\n  constructor(data = {}) {\n    this.appName = data.appName;\n    this.data = data.data || {};\n  }\n}\nexport class Window {\n  constructor(data = {}) {\n    this.id = data.id ? data.id : Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n    this.canMinimize = data.canMinimize || false;\n    this.category = data.category || 'other';\n    this.defHeight = data.defHeight || 400;\n    this.defWidth = data.defWidth || 850;\n    this.description = data.description || '';\n    this.icon = data.icon || '';\n    this.iconclass = data.iconclass || '';\n    this.isMaximized = data.isMaximized || false;\n    this.label = data.label || 'Unknown';\n    this.name = data.name || \"Unknown name\";\n    this.resizable = data.resizable || false;\n    this.showInStartMenu = data.showInStartMenu || false;\n    this.showOnDesktop = data.showOnDesktop || false;\n    this.zIndex = data.zIndex || nextZIndex++;\n    this.positionx = data.positionx || getRandomPosPixel();\n    this.positiony = data.positiony || getRandomPosPixel();\n  }\n}\n\n// -=-=-=-=-=-=-Основные операции CRUD-=-=-=-=-=-=-\nexport const usersTable = {\n  // обновление|сохранение учетной записи\n  async save(userData) {\n    try {\n      const NUser = new User(userData);\n      if (NUser.id) {\n        // Преобразуем объект User в простой объект для IndexedDB\n        const userForDB = this.prepareUserForDB(NUser);\n        userForDB.updatedAt = new Date();\n        await DB.users.update(userForDB.id, userForDB);\n        return NUser;\n      } else {\n        // зачищаем id в NUser (автоматически сгенерирует)\n        delete NUser.id;\n        NUser.apps = await getDefaultApps();\n        NUser.createdAt = new Date();\n        NUser.updatedAt = new Date();\n        return await DB.users.add(NUser);\n      }\n    } catch (error) {\n      console.error('Error operation (users; save):', error);\n      throw new Error(`Failed to save user: ${error.message}`);\n    }\n  },\n  // Функция для проверки сериализуемости\n  isSerializable(value) {\n    if (value === null || value === undefined) return true;\n    if (typeof value === 'boolean' || typeof value === 'number' || typeof value === 'string') return true;\n    if (value instanceof Date) return true;\n    try {\n      JSON.stringify(value);\n      return true;\n    } catch {\n      return false;\n    }\n  },\n  // Функция для создания безопасной копии\n  createSafeCopy(value) {\n    const self = this;\n\n    // Базовая проверка на null/undefined\n    if (value === null || value === undefined) return undefined;\n\n    // Проверка сериализуемости\n    if (!this.isSerializable(value)) return undefined;\n\n    // Примитивные типы возвращаем как есть\n    if (typeof value !== 'object' || value instanceof Date) return value;\n\n    // Обработка массивов\n    if (Array.isArray(value)) {\n      return value.map(item => self.createSafeCopy(item)).filter(item => item !== undefined);\n    }\n\n    // Обработка объектов\n    const result = {};\n    Object.entries(value).forEach(([key, val]) => {\n      // Пропускаем функции\n      if (typeof val === 'function') return;\n\n      // Проверяем сериализуемость значения\n      if (self.isSerializable(val)) {\n        const copied = self.createSafeCopy(val);\n        if (copied !== undefined) {\n          result[key] = copied;\n        }\n      }\n    });\n    return result;\n  },\n  prepareUserForDB(user) {\n    // Создаем безопасный объект для сохранения\n    const self = this;\n    return {\n      id: user.id,\n      login: user.login || '',\n      name: user.name || '',\n      password: user.password || '',\n      apps: Array.isArray(user.apps) ? user.apps.map(app => self.createSafeCopy(app)).filter(app => app && Object.keys(app).length > 0) : [],\n      data: this.createSafeCopy(user.data) || {},\n      config: this.createSafeCopy(user.config) || {\n        avatar: \"cat.jpg\"\n      },\n      systemconfig: this.createSafeCopy(user.systemconfig) || Def_userSystemconfig,\n      createdAt: user.createdAt instanceof Date ? user.createdAt : user.createdAt ? new Date(user.createdAt) : new Date(),\n      updatedAt: user.updatedAt instanceof Date ? user.updatedAt : user.updatedAt ? new Date(user.updatedAt) : new Date()\n    };\n  },\n  // поиск учетной записи по id\n  async getbyId(id) {\n    try {\n      return await DB.users.get(id);\n    } catch (error) {\n      console.error('Error operation (users; getbyId):', error);\n      throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n    }\n  },\n  // поиск учетной записи по login\n  async getbyLogin(login) {\n    try {\n      return await DB.users.where('login').equals(login).first();\n    } catch (error) {\n      console.error('Error operation (users; getbyLogin):', error);\n      throw new Error(`Failed to get user by login ${login}: ${error.message}`);\n    }\n  },\n  // получить массив всех учетных записей\n  async getAll() {\n    try {\n      return await DB.users.toArray();\n    } catch (error) {\n      console.error('Error operation (users; getAll):', error);\n      throw new Error(`Failed to get all users`);\n    }\n  },\n  // получить массив apps учетной записи\n  async getApps(id) {\n    try {\n      const USER = await DB.users.get(id);\n      if (USER && USER.apps) {\n        return USER.apps;\n      } else {\n        console.error('Error operation (users; getApps).');\n      }\n    } catch (error) {\n      console.error('Error operation (users; getApps):', error);\n      throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n    }\n  },\n  // получить config пользователя по id\n  async getConfig(id) {\n    try {\n      const USER = await DB.users.get(id);\n      if (USER && USER.config) {\n        return USER.config;\n      } else {\n        console.error('Error operation (users; getConfig).');\n      }\n    } catch (error) {\n      console.error('Error operation (users; getConfig):', error);\n      throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n    }\n  },\n  // получить systemconfig пользователя по id\n  async getSConfig(id) {\n    try {\n      const USER = await DB.users.get(id);\n      if (USER && USER.systemconfig) {\n        return USER.systemconfig;\n      } else {\n        console.error('Error operation (users; getSConfig).');\n      }\n    } catch (error) {\n      console.error('Error operation (users; getSConfig):', error);\n      throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n    }\n  },\n  // обновление конфигуратора приложений в учетной записи\n  async updateAppSetting(userId, appId, key, value) {\n    if (!userId) throw new Error('User ID required');\n    try {\n      // Получаем пользователя\n      const user = await DB.users.get(userId);\n      if (!user) {\n        throw new Error(`Пользователь с ID ${userId} не найден`);\n      }\n\n      // Находим приложение в массиве apps\n      const appIndex = user.apps.findIndex(app => app.id === appId);\n      if (appIndex === -1) {\n        throw new Error(`Приложение с ID ${appId} не найдено у пользователя ${userId}`);\n      }\n\n      // Обновляем значение ключа\n      // Используем $set для реактивного обновления, если это необходимо\n      const updatedApps = [...user.apps];\n      updatedApps[appIndex] = {\n        ...updatedApps[appIndex],\n        [key]: value\n      };\n\n      // Сохраняем обновленный массив приложений\n      await DB.users.update(userId, {\n        apps: updatedApps,\n        updatedAt: new Date()\n      });\n      return {\n        success: true,\n        userId,\n        appId,\n        key,\n        value\n      };\n    } catch (error) {\n      console.error('Error operation (users; updateAppSetting):', error);\n      throw new Error(`Failed to update app setting: ${error.message}`);\n    }\n  },\n  // удалить учетную запись\n  async delete(id) {\n    try {\n      return await DB.users.delete(id);\n    } catch (error) {\n      console.error('Error operation (users; delete):', error);\n      throw new Error(`Failed to delete user ${id}: ${error.message}`);\n    }\n  },\n  // кол-во учетных записей\n  async count() {\n    try {\n      return await DB.users.count();\n    } catch (error) {\n      console.error('Error operation (users; count):', error);\n      throw new Error(`Failed to count users`);\n    }\n  },\n  async search(query) {\n    try {\n      return await DB.users.filter(user => user.login.toLowerCase().includes(query.toLowerCase()) || JSON.stringify(user.data).toLowerCase().includes(query.toLowerCase())).toArray();\n    } catch (error) {\n      console.error('Error operation (users; search');\n      throw new Error(`Search failed: ${error.message}`);\n    }\n  },\n  windows: {\n    async reupdate(userId) {\n      if (!userId) throw new Error('User ID required');\n      try {\n        const FindWindows = await this.windows_getAll(userId);\n\n        // Убедимся, что у всех окон есть zIndex\n        const windowsWithZIndex = FindWindows.map(w => ({\n          ...w,\n          zIndex: w.zIndex || 100\n        }));\n        IDBWindows.value = windowsWithZIndex;\n\n        // Обновляем activeWindowId\n        const user = await DB.users.get(userId);\n        if (user && user.systemconfig) activeWindowId.value = user.systemconfig.activeWindowId;\n        return {\n          success: true,\n          userId\n        };\n      } catch (error) {\n        console.error('Failed to reupdate windows:', error);\n        throw new Error(`Failed to reupdate windows: ${error.message}`);\n      }\n    },\n    // создание нового окна с обновлением данных\n    async create(userId, appData) {\n      // валидация\n      if (!appData.name) throw new Error('App name required!');\n\n      // Используем существующий id или создаем новый\n      const windowId = appData.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n      try {\n        // Получаем текущие окна из БД\n        const user = await DB.users.get(userId);\n        if (!user) throw new Error(`User with ID ${userId} not found`);\n        const currentWindows = user?.systemconfig?.windows || [];\n\n        // Проверяем, существует ли уже окно с таким ID\n        const existingWindowIndex = currentWindows.findIndex(w => w.id === windowId);\n        let newWindows;\n        let targetWindow;\n        if (existingWindowIndex !== -1) {\n          // Окно уже существует - используем его с сохраненными координатами\n          targetWindow = currentWindows[existingWindowIndex];\n\n          // Обновляем только некоторые свойства, но сохраняем позицию\n          targetWindow = {\n            ...targetWindow,\n            ...appData,\n            id: windowId,\n            // сохраняем ID\n            // НЕ перезаписываем positionx и positiony, если они не переданы явно\n            positionx: appData.positionx !== undefined ? appData.positionx : targetWindow.positionx,\n            positiony: appData.positiony !== undefined ? appData.positiony : targetWindow.positiony,\n            isMinimized: false\n          };\n          newWindows = [...currentWindows];\n          newWindows[existingWindowIndex] = targetWindow;\n        } else {\n          // Новое окно - определяем zIndex\n          let maxZIndex = 100;\n          if (currentWindows.length > 0) {\n            const zIndices = currentWindows.map(w => w.zIndex || 100);\n            maxZIndex = Math.max(...zIndices, 100);\n          }\n          const newZIndex = maxZIndex + 1;\n\n          // Создаем новое окно с переданными координатами или рандомными\n          targetWindow = new Window({\n            ...appData,\n            id: windowId,\n            zIndex: newZIndex,\n            isMinimized: false,\n            // Если координаты переданы, используем их, иначе будут рандомные из конструктора\n            positionx: appData.positionx,\n            positiony: appData.positiony\n          });\n          newWindows = [...currentWindows, targetWindow];\n        }\n\n        // Устанавливаем активное окно\n        activeWindowId.value = windowId;\n\n        // Обновляем системную конфигурацию пользователя\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig.windows = newWindows;\n          user.systemconfig.activeWindowId = windowId;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем реактивную переменную\n        IDBWindows.value = newWindows;\n        return targetWindow;\n      } catch (error) {\n        console.error('Error creating/updating window:', error);\n        throw error;\n      }\n    },\n    // получить список всех окон по ID пользователя\n    async windows_getAll(userId) {\n      if (!userId) throw new Error('User ID required');\n      const user = await DB.users.get(userId);\n      if (!user) throw new Error(`User with ID ${userId} not found`);\n      const windows = user?.systemconfig?.windows || [];\n\n      // Убедимся, что у каждого окна есть zIndex\n      const windowsWithZIndex = windows.map(w => ({\n        ...w,\n        zIndex: w.zIndex || 100\n      }));\n      return windowsWithZIndex;\n    },\n    // получение конкретного окна по ID пользователя + ID окна\n    async getById(userId, windowId) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      const user = await DB.users.get(userId);\n      if (!user) throw new Error(`User with ID ${userId} not found`);\n      const findWindows = user?.systemconfig?.windows || [];\n      let result = null;\n      findWindows.forEach(function (val) {\n        if (val.id === windowId) result = val;\n      });\n      return result;\n    },\n    // проверка наличия окна по ID пользователя + ID окна\n    async exists(userId, windowId) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      try {\n        const window = await this.getById(userId, windowId);\n        return window !== null;\n      } catch {\n        return false;\n      }\n    },\n    // возвращает \"следующее\" значение zIndex, которое можно использовать\n    async getCurZIndex(userId) {\n      if (!userId) throw new Error('User ID required');\n      let maxZIndex = 100;\n      try {\n        const findWindows = await this.windows_getAll(userId);\n        if (findWindows && findWindows.length > 0) {\n          findWindows.forEach(function (value) {\n            if (value.zIndex > maxZIndex) maxZIndex = value.zIndex;\n          });\n          return maxZIndex + 1;\n        } else {\n          return maxZIndex;\n        }\n      } catch {\n        return maxZIndex;\n      }\n    },\n    // Сохраняем все окна в systemconfig.windows пользователя\n    async saveWindowsToUser(userId) {\n      if (!userId) throw new Error('User ID required');\n      try {\n        const user = await DB.users.get(userId);\n        const nWindows = IDBWindows.value.map(w => new Window(w));\n        // const nWindows = IDBWindows.value.map(w => (this.prepareWindowForDB(w)));\n\n        let uSystemconfig = user.systemconfig || Def_userSystemconfig;\n        uSystemconfig.windows = nWindows;\n        uSystemconfig.activeWindowId = activeWindowId.value;\n\n        // Сохраняем обновленный systemconfig\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig = uSystemconfig;\n          user.updatedAt = new Date();\n        });\n        return {\n          success: true,\n          userId\n        };\n      } catch (error) {\n        console.error('Failed to save windows to IDB:', error);\n        throw new Error(`Failed to update user's systemconfig/windows: ${error.message}`);\n      }\n    },\n    // активирование окна (поднятие его zIndex)\n    async activate(userId, windowId) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      try {\n        // Получаем пользователя\n        const user = await DB.users.get(userId);\n        const windows = user?.systemconfig?.windows || [];\n\n        // Находим окно\n        const windowIndex = windows.findIndex(w => w.id === windowId);\n        if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n\n        // Если окно свернуто - разворачиваем его\n        if (windows[windowIndex].isMinimized) windows[windowIndex].isMinimized = false;\n\n        // Находим текущий максимальный zIndex\n        const maxZIndex = Math.max(...windows.map(w => w.zIndex || 100), 100);\n        const newZIndex = maxZIndex + 1;\n\n        // Обновляем zIndex активируемого окна\n        windows[windowIndex].zIndex = newZIndex;\n\n        // Обновляем конфиг\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig.windows = windows;\n          user.systemconfig.activeWindowId = windowId;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем реактивную переменную\n        IDBWindows.value = windows;\n        activeWindowId.value = windowId;\n        return {\n          success: true\n        };\n      } catch (error) {\n        console.error('Failed to activate window:', error);\n        throw error;\n      }\n    },\n    // поиск \"окна\" в SConfig пользователя по данным приложения\n    async getWindow_byConfig(userId, appData) {\n      if (!userId) throw new Error('User ID required');\n      if (!appData) throw new Error('appData required');\n      try {\n        const FindWindows = await this.windows_getAll(userId);\n        if (FindWindows && FindWindows.length > 0) {\n          let res = false;\n          FindWindows.forEach(function (val) {\n            if (appData && appData.name && val.name === appData.name) res = val;\n          });\n          return res;\n        } else {\n          return false;\n        }\n      } catch (error) {\n        console.error('Error operation(users; getSConfig_window_byConfig).', error);\n        throw new Error(`Failed: ${error.message}`);\n      }\n    },\n    // сворачивание окна\n    async minimize(userId, windowId) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      try {\n        // Получаем пользователя\n        const user = await DB.users.get(userId);\n        if (!user) throw new Error(`User with ID ${userId} not found`);\n        const windows = user?.systemconfig?.windows || [];\n\n        // Находим индекс сворачиваемого окна\n        const windowIndex = windows.findIndex(w => w.id === windowId);\n        if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n\n        // Устанавливаем isMinimized в true\n        windows[windowIndex].isMinimized = true;\n\n        // Определяем новое активное окно (окно с максимальным zIndex среди не свернутых)\n        const nonMinimizedWindows = windows.filter(w => !w.isMinimized);\n        let newActiveWindowId = null;\n        if (nonMinimizedWindows.length > 0) {\n          // Находим окно с максимальным zIndex среди не свернутых\n          newActiveWindowId = nonMinimizedWindows.reduce((max, w) => w.zIndex > max.zIndex ? w : max, nonMinimizedWindows[0]).id;\n        }\n        console.log('Window minimized, new active window:', newActiveWindowId);\n\n        // Обновляем конфиг\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig.windows = windows;\n          user.systemconfig.activeWindowId = newActiveWindowId;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем глобальные переменные\n        activeWindowId.value = newActiveWindowId;\n        IDBWindows.value = windows;\n        return {\n          success: true,\n          userId,\n          windowId,\n          newActiveWindowId\n        };\n      } catch (error) {\n        console.error('Failed to minimize window:', error);\n        throw new Error(`Failed to minimize window: ${error.message}`);\n      }\n    },\n    // восстановление окна из свернутого состояния\n    async restore(userId, windowId) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      try {\n        // Получаем пользователя\n        const user = await DB.users.get(userId);\n        if (!user) throw new Error(`User with ID ${userId} not found`);\n        const windows = user?.systemconfig?.windows || [];\n\n        // Находим индекс восстанавливаемого окна\n        const windowIndex = windows.findIndex(w => w.id === windowId);\n        if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n\n        // Устанавливаем isMinimized в false\n        windows[windowIndex].isMinimized = false;\n\n        // Получаем текущий максимальный zIndex\n        const maxZIndex = Math.max(...windows.map(w => w.zIndex || 100), 100);\n        const newZIndex = maxZIndex + 1;\n\n        // Обновляем zIndex восстанавливаемого окна\n        windows[windowIndex].zIndex = newZIndex;\n        console.log('Window restored with zIndex:', newZIndex);\n\n        // Обновляем конфиг\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig.windows = windows;\n          user.systemconfig.activeWindowId = windowId;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем глобальные переменные\n        activeWindowId.value = windowId;\n        IDBWindows.value = windows;\n        return {\n          success: true,\n          userId,\n          windowId,\n          zIndex: newZIndex\n        };\n      } catch (error) {\n        console.error('Failed to restore window:', error);\n        throw new Error(`Failed to restore window: ${error.message}`);\n      }\n    },\n    // \"закрытие\" окна у пользователя\n    async close(userId, windowId) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      try {\n        const FindWindows = await this.windows_getAll(userId);\n\n        // Фильтруем окна, удаляя закрываемое\n        const resultArray = FindWindows.filter(val => val.id !== windowId);\n\n        // Обновляем реактивную переменную\n        IDBWindows.value = resultArray;\n\n        // Получаем пользователя и обновляем его конфиг\n        const user = await DB.users.get(userId);\n        let uSystemconfig = user.systemconfig || Def_userSystemconfig;\n\n        // Обновляем windows в конфиге\n        uSystemconfig.windows = resultArray.map(w => new Window(w));\n        // uSystemconfig.windows = resultArray.map(w => this.prepareWindowForDB(w));\n\n        // Если закрываем активное окно, активируем другое\n        if (uSystemconfig.activeWindowId === windowId) {\n          if (resultArray.length > 0) {\n            // Активируем окно с максимальным zIndex\n            const windowsWithZIndex = resultArray.map(w => ({\n              ...w,\n              zIndex: w.zIndex || 100\n            }));\n            const maxZWindow = windowsWithZIndex.reduce((max, w) => w.zIndex > max.zIndex ? w : max);\n            uSystemconfig.activeWindowId = maxZWindow.id;\n            activeWindowId.value = maxZWindow.id;\n          } else {\n            uSystemconfig.activeWindowId = null;\n            activeWindowId.value = null;\n          }\n        }\n\n        // Сохраняем в БД\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig = uSystemconfig;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем nextZIndex\n        if (resultArray.length > 0) {\n          const maxZ = Math.max(...resultArray.map(w => w.zIndex));\n          nextZIndex = maxZ + 1;\n        } else {\n          nextZIndex = 100;\n        }\n        return {\n          success: true,\n          userId,\n          windowId\n        };\n      } catch (error) {\n        console.error('Error operation(users; windows.close).', error);\n        throw new Error(`Failed: ${error.message}`);\n      }\n    },\n    // фиксирование новых координат окна\n    async updatePosition(userId, windowId, positionx, positiony) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      if (positionx === undefined || positiony === undefined) throw new Error('Position coordinates required');\n      try {\n        // Получаем пользователя\n        const user = await DB.users.get(userId);\n        if (!user) throw new Error(`User with ID ${userId} not found`);\n        const windows = user?.systemconfig?.windows || [];\n\n        // Находим индекс окна\n        const windowIndex = windows.findIndex(w => w.id === windowId);\n        if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n\n        // Обновляем позицию окна\n        windows[windowIndex].positionx = positionx;\n        windows[windowIndex].positiony = positiony;\n\n        // Обновляем конфиг в БД\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig.windows = windows;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем реактивную переменную\n        IDBWindows.value = windows;\n        return {\n          success: true,\n          userId,\n          windowId,\n          positionx,\n          positiony\n        };\n      } catch (error) {\n        console.error('Error updating window position:', error);\n        throw new Error(`Failed to update window position: ${error.message}`);\n      }\n    },\n    async updateSize(userId, windowId, width, height) {\n      if (!userId) throw new Error('User ID required');\n      if (!windowId) throw new Error('Window ID required');\n      if (width === undefined || height === undefined) throw new Error('Width and height required');\n      try {\n        // Получаем пользователя\n        const user = await DB.users.get(userId);\n        if (!user) throw new Error(`User with ID ${userId} not found`);\n        const windows = user?.systemconfig?.windows || [];\n\n        // Находим индекс окна\n        const windowIndex = windows.findIndex(w => w.id === windowId);\n        if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n\n        // Обновляем размеры окна\n        windows[windowIndex].defWidth = width;\n        windows[windowIndex].defHeight = height;\n\n        // Обновляем конфиг в БД\n        await DB.users.where('id').equals(userId).modify(user => {\n          user.systemconfig.windows = windows;\n          user.updatedAt = new Date();\n        });\n\n        // Обновляем реактивную переменную\n        IDBWindows.value = windows;\n        return {\n          success: true,\n          userId,\n          windowId,\n          width,\n          height\n        };\n      } catch (error) {\n        console.error('Error updating window size:', error);\n        throw new Error(`Failed to update window size: ${error.message}`);\n      }\n    }\n  },\n  windowsstates: {\n    // получить список всех состояний окон по ID пользователя\n    async getAll(userId) {\n      if (!userId) throw new Error('User ID required');\n      const user = await DB.users.get(userId);\n      if (!user) throw new Error(`User with ID ${userId} not found`);\n      const states = user?.windowsstates || [];\n      return states;\n    }\n  }\n};\nexport const settingsTable = {\n  // сохранение настройки\n  async save(key, value) {\n    try {\n      const existing = await DB.settings.where('key').equals(key).first();\n      if (existing) {\n        await DB.settings.update(existing.id, {\n          value: value,\n          updatedAt: new Date()\n        });\n        return existing.id;\n      } else {\n        return await DB.settings.add(new Setting(key, value));\n      }\n    } catch (error) {\n      console.error('Error operation (settings; save');\n      throw new Error(`Failed to save setting ${key}: ${error.message}`);\n    }\n  },\n  // получить настройку\n  async get(key, defaultVal = null) {\n    try {\n      const findSetting = DB.settings.where('key').equals(key).first();\n      return findSetting ? findSetting.value : defaultVal;\n    } catch (error) {\n      console.error('Error operation (settings; get');\n      throw new Error(`Failed to get setting ${key}: ${error.message}`);\n    }\n  },\n  // удалить настройку\n  async delete(key) {\n    try {\n      const findSetting = await DB.settings.where('key').equals(key).first();\n      if (findSetting) {\n        return await DB.settings.delete(findSetting.id);\n      } else {\n        return null;\n      }\n    } catch (error) {\n      console.error('Error operation (settings; delete');\n      throw new Error(`Failed to delete setting ${key}: ${error.message}`);\n    }\n  },\n  // получить все настройки\n  async getAll() {\n    try {\n      return await DB.settings.toArray();\n    } catch (error) {\n      console.error('Error operation (settings; getAll');\n      throw new Error(`Failed to get all settings`);\n    }\n  }\n};\n\n// -=-=-=-=-=-=-Служебное-=-=-=-=-=-=-\n\n// инициализация БД с тестовыми данными\nexport async function initDatabase() {\n  try {\n    // проверка, пустая ли база\n    const userCount = await usersTable.count();\n    if (userCount === 0) {\n      // Загружаем apps асинхронно\n      const defaultAppsList = await getDefaultApps();\n\n      // создание базового пользователя\n      const defaultUser = new User({\n        login: 'user',\n        password: '',\n        apps: defaultAppsList,\n        data: {},\n        config: {\n          avatar: 'robot.jpg'\n        },\n        systemconfig: {\n          desktopWallpaper: \"nwall.jpg\"\n        }\n      });\n      await usersTable.save(defaultUser);\n      console.log('Default user created.');\n    }\n\n    // инициализация базовых настроек \n    const defaultSettings = [['theme', 'dark'], ['avatarDefault', 'cat']];\n    for (const [key, value] of defaultSettings) {\n      const existing = await settingsTable.get(key);\n      if (existing === null) {\n        await settingsTable.set(key, value);\n      }\n    }\n    console.log('Database initialized successfully');\n    return true;\n  } catch (error) {\n    console.error('Error initializing DB:', error);\n    throw error;\n  }\n}\n\n/**\n * Очистка базы данных (осторожно!)\n */\nexport async function clearDatabase() {\n  try {\n    await Promise.all([DB.users.clear(), DB.settings.clear()]);\n    console.log('Database cleared');\n  } catch (error) {\n    console.error('Error clearing database:', error);\n    throw error;\n  }\n}\n\n// ==================== МИГРАЦИИ (пример, не факт что рабочий) ====================\n\n// Пример добавления миграции при увеличении версии\n// DB.version(2).stores({\n//     users: '++id, login, password, apps, data, config, systemConfig, createdAt, updatedAt, lastLogin',\n//     settings: '++id, key, value, updatedAt',\n//     sessions: '++id, userId, token, expiresAt, createdAt' // Новая таблица\n// }).upgrade(async (tx) => {\n//     // Добавляем поле lastLogin к существующим пользователям\n//     const users = await tx.users.toArray();\n//     await Promise.all(\n//         users.map(user => \n//             tx.users.update(user.id, { \n//                 lastLogin: null,\n//                 updatedAt: new Date() \n//             })\n//         )\n//     );\n\n//     console.log('Migration to version 2 completed');\n// });\n\nexport { DB, IDBWindows, activeWindowId };\nexport default {\n  DB,\n  User,\n  Window,\n  usersTable,\n  settingsTable,\n  initDatabase,\n  clearDatabase\n};","map":{"version":3,"names":["Dexie","ref","appsConfig","db_name","db_version","DB","getDefaultApps","apps","getAllApps","map","app","id","name","label","category","icon","iconclass","description","defWidth","defHeight","isMaximized","resizable","canMinimize","showOnDesktop","showInStartMenu","path","component","data","JSON","parse","stringify","version","stores","users","settings","Def_userConfig","avatar","Def_userSystemconfig","desktopWallpaper","windows","activeWindowId","Def_systemdata","windowsstates","nextZIndex","IDBWindows","getRandomPosPixel","min","Math","ceil","max","floor","random","User","constructor","login","password","config","systemconfig","systemdata","createdAt","Date","updatedAt","Setting","key","value","WindowState","appName","Window","now","toString","substr","zIndex","positionx","positiony","usersTable","save","userData","NUser","userForDB","prepareUserForDB","update","add","error","console","Error","message","isSerializable","undefined","createSafeCopy","self","Array","isArray","item","filter","result","Object","entries","forEach","val","copied","user","keys","length","getbyId","get","getbyLogin","where","equals","first","getAll","toArray","getApps","USER","getConfig","getSConfig","updateAppSetting","userId","appId","appIndex","findIndex","updatedApps","success","delete","count","search","query","toLowerCase","includes","reupdate","FindWindows","windows_getAll","windowsWithZIndex","w","create","appData","windowId","currentWindows","existingWindowIndex","newWindows","targetWindow","isMinimized","maxZIndex","zIndices","newZIndex","modify","getById","findWindows","exists","window","getCurZIndex","saveWindowsToUser","nWindows","uSystemconfig","activate","windowIndex","getWindow_byConfig","res","minimize","nonMinimizedWindows","newActiveWindowId","reduce","log","restore","close","resultArray","maxZWindow","maxZ","updatePosition","updateSize","width","height","states","settingsTable","existing","defaultVal","findSetting","initDatabase","userCount","defaultAppsList","defaultUser","defaultSettings","set","clearDatabase","Promise","all","clear"],"sources":["/home/kup/my_projects/vue/osi/src/idb/db.js"],"sourcesContent":["import Dexie from \"dexie\";\nimport { ref } from \"vue\";\nimport { appsConfig } from \"@/config/applications\";\n\n// конфигураторы БД\nconst db_name = 'OSIDB';\nconst db_version = 1;\n\n// инициализация БД\nconst DB = new Dexie(db_name);\n\n// const defaultApps = await appsConfig.getAllApps();\n// Функция для получения упрощенных объектов приложений\nasync function getDefaultApps() {\n    const apps = await appsConfig.getAllApps();\n    \n    // Преобразуем каждый объект приложения в упрощенную версию\n    return apps.map(app => ({\n        id: app.id,\n        name: app.name,\n        label: app.label,\n        category: app.category || 'Other',\n        icon: app.icon || '',\n        iconclass: app.iconclass || '',\n        description: app.description || '',\n        defWidth: app.defWidth || false,\n        defHeight: app.defHeight || false,\n        isMaximized: app.isMaximized || false,\n        resizable: app.resizable || false,\n        canMinimize: app.canMinimize || false,\n        showOnDesktop: app.showOnDesktop || false,\n        showInStartMenu: app.showInStartMenu || false,\n        // Сохраняем только базовые данные, удаляем функции и компоненты\n        path: app.path || '',\n        component: (app.component && app.component.name) ? app.component.name : 'Component',\n        // Добавляем только примитивные типы данных\n        data: app.data && typeof app.data === 'object' ? JSON.parse(JSON.stringify(app.data)) : {}        \n    }));\n}\n\n// описание схемы БД\nDB.version(db_version).stores({\n    users: '++id, name, login, password, apps, data, config, systemconfig, systemdata, createdAt, updatedAt',\n    settings: '++id, key, value, updatedAt',\n});\n\n// ========Default configs========\nconst Def_userConfig = { avatar: \"cat.jpg\" };\nconst Def_userSystemconfig = {\n    desktopWallpaper: \"nwall.jpg\",\n    windows: [],\n    activeWindowId: null,\n};\nconst Def_systemdata = {\n    windowsstates: [],\n};\n\nlet nextZIndex = 100;\nconst IDBWindows = ref([]);\nconst activeWindowId = ref(null);\n\nfunction getRandomPosPixel() {\n    const min = Math.ceil(50); // Округляем минимум вверх\n    const max = Math.floor(200); // Округляем максимум вниз\n\n    return Math.floor(Math.random() * (max - min + 1)) + min;\n}\n\n// -=-=-=-=-=-=-Описание классов моделей-=-=-=-=-=-=-\nexport class User {\n    constructor(data = {}) {\n        this.login = data.login || 'user';\n        this.name = data.name || 'User';\n        this.password = data.password || '';    //TODO ПРОДУМАТЬ РЕАЛЬНУЮ СХЕМУ ЗАЩИТЫ\n        this.apps = data.apps || [];\n        this.data = data.data || {};\n        this.config = data.config || Def_userConfig;\n        this.systemconfig = data.systemconfig || Def_userSystemconfig;\n        this.systemdata = data.systemdata || Def_systemdata;\n        this.createdAt = data.createdAt || new Date();\n        this.updatedAt = data.updatedAt || new Date();\n        // автоматическое присваение id (вариант для \"совместимости\")\n        if (data.id) this.id = data.id;\n    }\n}\n\nexport class Setting {\n    constructor(key, value) {\n        this.key = key;\n        this.value = value;\n        this.updatedAt = new Date();\n    }\n}\n\nexport class WindowState {\n    constructor(data = {}) {\n        this.appName = data.appName;\n        this.data = data.data || {};\n    }\n}\n\nexport class Window {\n    constructor(data = {}) {\n        this.id = (data.id) ? data.id : Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n        this.canMinimize = data.canMinimize || false;\n        this.category = data.category || 'other';\n        this.defHeight = data.defHeight || 400;\n        this.defWidth = data.defWidth || 850;\n        this.description = data.description || '';\n        this.icon = data.icon || '';\n        this.iconclass = data.iconclass || '';\n        this.isMaximized = data.isMaximized || false;\n        this.label = data.label || 'Unknown';\n        this.name = data.name || \"Unknown name\";\n        this.resizable = data.resizable || false;\n        this.showInStartMenu = data.showInStartMenu || false;\n        this.showOnDesktop = data.showOnDesktop || false;\n        this.zIndex = data.zIndex || nextZIndex++;\n        this.positionx = data.positionx || getRandomPosPixel();\n        this.positiony = data.positiony || getRandomPosPixel();\n    }\n}\n\n// -=-=-=-=-=-=-Основные операции CRUD-=-=-=-=-=-=-\nexport const usersTable = {\n    // обновление|сохранение учетной записи\n    async save(userData) {\n        try {\n            const NUser = new User(userData);\n\n            if (NUser.id) {\n                // Преобразуем объект User в простой объект для IndexedDB\n                const userForDB = this.prepareUserForDB(NUser);\n\n                userForDB.updatedAt = new Date();\n                await DB.users.update(userForDB.id, userForDB);\n\n                return NUser;\n            } else {\n                // зачищаем id в NUser (автоматически сгенерирует)\n                delete NUser.id;\n\n                NUser.apps = await getDefaultApps();\n                NUser.createdAt = new Date();\n                NUser.updatedAt = new Date();\n\n                return await DB.users.add(NUser);\n            }\n        } catch (error) {\n            console.error('Error operation (users; save):', error);            \n            throw new Error(`Failed to save user: ${error.message}`);\n        }\n    },\n\n    // Функция для проверки сериализуемости\n    isSerializable(value) {\n        if (value === null || value === undefined) return true;\n        if (typeof value === 'boolean' || typeof value === 'number' || typeof value === 'string') return true;\n        if (value instanceof Date) return true;\n        \n        try {\n            JSON.stringify(value);\n            return true;\n        } catch {\n            return false;\n        }\n    },\n\n    // Функция для создания безопасной копии\n    createSafeCopy(value) {\n        const self = this;\n        \n        // Базовая проверка на null/undefined\n        if (value === null || value === undefined) return undefined;\n        \n        // Проверка сериализуемости\n        if (!this.isSerializable(value)) return undefined;\n        \n        // Примитивные типы возвращаем как есть\n        if (typeof value !== 'object' || value instanceof Date) return value;\n        \n        // Обработка массивов\n        if (Array.isArray(value)) {\n            return value\n                .map(item => self.createSafeCopy(item))\n                .filter(item => item !== undefined);\n        }\n        \n        // Обработка объектов\n        const result = {};\n        Object.entries(value).forEach(([key, val]) => {\n            // Пропускаем функции\n            if (typeof val === 'function') return;\n            \n            // Проверяем сериализуемость значения\n            if (self.isSerializable(val)) {\n                const copied = self.createSafeCopy(val);\n                if (copied !== undefined) {\n                    result[key] = copied;\n                }\n            }\n        });\n        \n        return result;\n    },\n\n    prepareUserForDB(user) {\n        // Создаем безопасный объект для сохранения\n        const self = this;\n        \n        return {\n            id: user.id,\n            login: user.login || '',\n            name: user.name || '',\n            password: user.password || '',\n            apps: Array.isArray(user.apps) \n                ? user.apps\n                    .map(app => self.createSafeCopy(app))\n                    .filter(app => app && Object.keys(app).length > 0) \n                : [],\n            data: this.createSafeCopy(user.data) || {},\n            config: this.createSafeCopy(user.config) || { avatar: \"cat.jpg\" },\n            systemconfig: this.createSafeCopy(user.systemconfig) || Def_userSystemconfig,\n            createdAt: user.createdAt instanceof Date ? user.createdAt : (user.createdAt ? new Date(user.createdAt) : new Date()),\n            updatedAt: user.updatedAt instanceof Date ? user.updatedAt : (user.updatedAt ? new Date(user.updatedAt) : new Date())\n        };\n    },\n\n    // поиск учетной записи по id\n    async getbyId(id) {\n        try {\n            return await DB.users.get(id);\n        } catch (error) {\n            console.error('Error operation (users; getbyId):', error);            \n            throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n        }\n    },\n\n    // поиск учетной записи по login\n    async getbyLogin(login) {\n        try {\n            return await DB.users.where('login').equals(login).first();\n        } catch (error) {\n            console.error('Error operation (users; getbyLogin):', error);\n            throw new Error(`Failed to get user by login ${login}: ${error.message}`);\n        }\n    },\n\n    // получить массив всех учетных записей\n    async getAll() {\n        try {\n            return await DB.users.toArray();\n        } catch (error) {\n            console.error('Error operation (users; getAll):', error);\n            throw new Error(`Failed to get all users`);\n        }\n    },\n\n    // получить массив apps учетной записи\n    async getApps(id) {\n        try {\n            const USER = await DB.users.get(id);\n            if (USER && USER.apps) {\n                return USER.apps;\n            } else {\n                console.error('Error operation (users; getApps).');\n            }\n        } catch (error) {\n            console.error('Error operation (users; getApps):', error);            \n            throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n        }\n    },\n\n    // получить config пользователя по id\n    async getConfig(id) {\n        try {\n            const USER = await DB.users.get(id);\n            if (USER && USER.config) {\n                return USER.config;\n            } else {\n                console.error('Error operation (users; getConfig).');\n            }\n        } catch (error) {\n            console.error('Error operation (users; getConfig):', error);            \n            throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n        }\n    },\n\n    // получить systemconfig пользователя по id\n    async getSConfig(id) {\n        try {\n            const USER = await DB.users.get(id);\n            if (USER && USER.systemconfig) {\n                return USER.systemconfig;\n            } else {\n                console.error('Error operation (users; getSConfig).');\n            }\n        } catch (error) {\n            console.error('Error operation (users; getSConfig):', error);            \n            throw new Error(`Failed to get user by id ${id}: ${error.message}`);\n        }\n    },\n\n    // обновление конфигуратора приложений в учетной записи\n    async updateAppSetting(userId, appId, key, value) {\n        if (!userId) throw new Error('User ID required');\n        \n        try {\n            // Получаем пользователя\n            const user = await DB.users.get(userId);\n            \n            if (!user) {\n                throw new Error(`Пользователь с ID ${userId} не найден`);\n            }\n            \n            // Находим приложение в массиве apps\n            const appIndex = user.apps.findIndex(app => app.id === appId);\n            if (appIndex === -1) {\n                throw new Error(`Приложение с ID ${appId} не найдено у пользователя ${userId}`);\n            }\n            \n            // Обновляем значение ключа\n            // Используем $set для реактивного обновления, если это необходимо\n            const updatedApps = [...user.apps];\n            \n            updatedApps[appIndex] = {\n                ...updatedApps[appIndex],\n                [key]: value\n            };\n            \n            // Сохраняем обновленный массив приложений\n            await DB.users.update(userId, {\n                apps: updatedApps,\n                updatedAt: new Date()\n            });\n            \n            return { success: true, userId, appId, key, value };\n            \n        } catch (error) {\n            console.error('Error operation (users; updateAppSetting):', error);\n            throw new Error(`Failed to update app setting: ${error.message}`);\n        }\n    },\n\n    // удалить учетную запись\n    async delete(id) {\n        try {\n            return await DB.users.delete(id);\n        } catch (error) {\n            console.error('Error operation (users; delete):', error);\n            throw new Error(`Failed to delete user ${id}: ${error.message}`);\n        }\n    },\n\n    // кол-во учетных записей\n    async count() {\n        try {\n            return await DB.users.count();\n        } catch (error) {\n            console.error('Error operation (users; count):', error);\n            throw new Error(`Failed to count users`);\n        }\n    },\n\n    async search(query) {\n        try {\n            return await DB.users\n                .filter(user =>\n                    user.login.toLowerCase().includes(query.toLowerCase()) ||\n                    JSON.stringify(user.data).toLowerCase().includes(query.toLowerCase())\n                ).toArray();\n        } catch (error) {\n            console.error('Error operation (users; search');\n            throw new Error(`Search failed: ${error.message}`);\n        }\n    },\n\n    windows: {\n        async reupdate(userId) {\n            if (!userId) throw new Error('User ID required');\n\n            try {\n                const FindWindows = await this.windows_getAll(userId);\n                \n                // Убедимся, что у всех окон есть zIndex\n                const windowsWithZIndex = FindWindows.map(w => ({\n                    ...w,\n                    zIndex: w.zIndex || 100\n                }));\n                \n                IDBWindows.value = windowsWithZIndex;\n                \n                // Обновляем activeWindowId\n                const user = await DB.users.get(userId);\n\n                if (user && user.systemconfig) activeWindowId.value = user.systemconfig.activeWindowId;\n                \n                return { success: true, userId };\n            } catch (error) {\n                console.error('Failed to reupdate windows:', error);\n                throw new Error(`Failed to reupdate windows: ${error.message}`);\n            }\n        },\n\n        // создание нового окна с обновлением данных\n        async create(userId, appData) {\n            // валидация\n            if (!appData.name) throw new Error('App name required!');\n\n            // Используем существующий id или создаем новый\n            const windowId = appData.id || Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n            \n            try {                \n                // Получаем текущие окна из БД\n                const user = await DB.users.get(userId);\n                if (!user) throw new Error(`User with ID ${userId} not found`);\n                \n                const currentWindows = user?.systemconfig?.windows || [];\n                \n                // Проверяем, существует ли уже окно с таким ID\n                const existingWindowIndex = currentWindows.findIndex(w => w.id === windowId);\n                \n                let newWindows;\n                let targetWindow;\n                \n                if (existingWindowIndex !== -1) {\n                    // Окно уже существует - используем его с сохраненными координатами\n                    targetWindow = currentWindows[existingWindowIndex];\n                    \n                    // Обновляем только некоторые свойства, но сохраняем позицию\n                    targetWindow = {\n                        ...targetWindow,\n                        ...appData,\n                        id: windowId, // сохраняем ID\n                        // НЕ перезаписываем positionx и positiony, если они не переданы явно\n                        positionx: appData.positionx !== undefined ? appData.positionx : targetWindow.positionx,\n                        positiony: appData.positiony !== undefined ? appData.positiony : targetWindow.positiony,\n                        isMinimized: false\n                    };\n                    \n                    newWindows = [...currentWindows];\n                    newWindows[existingWindowIndex] = targetWindow;\n                } else {\n                    // Новое окно - определяем zIndex\n                    let maxZIndex = 100;\n                    if (currentWindows.length > 0) {\n                        const zIndices = currentWindows.map(w => w.zIndex || 100);\n                        maxZIndex = Math.max(...zIndices, 100);\n                    }\n                    \n                    const newZIndex = maxZIndex + 1;\n                    \n                    // Создаем новое окно с переданными координатами или рандомными\n                    targetWindow = new Window({\n                        ...appData,\n                        id: windowId,\n                        zIndex: newZIndex,\n                        isMinimized: false,\n                        // Если координаты переданы, используем их, иначе будут рандомные из конструктора\n                        positionx: appData.positionx,\n                        positiony: appData.positiony\n                    });\n                    \n                    newWindows = [...currentWindows, targetWindow];\n                }\n\n                // Устанавливаем активное окно\n                activeWindowId.value = windowId;\n\n                // Обновляем системную конфигурацию пользователя\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig.windows = newWindows;\n                        user.systemconfig.activeWindowId = windowId;\n                        user.updatedAt = new Date();\n                    });\n\n                // Обновляем реактивную переменную\n                IDBWindows.value = newWindows;\n                \n                return targetWindow;\n            } catch (error) {\n                console.error('Error creating/updating window:', error);\n                throw error;\n            }\n        },\n\n        // получить список всех окон по ID пользователя\n        async windows_getAll(userId) {\n            if (!userId) throw new Error('User ID required');\n            \n            const user = await DB.users.get(userId);\n\n            if (!user) throw new Error(`User with ID ${userId} not found`);\n            \n            const windows = user?.systemconfig?.windows || [];\n            \n            // Убедимся, что у каждого окна есть zIndex\n            const windowsWithZIndex = windows.map(w => ({\n                ...w,\n                zIndex: w.zIndex || 100\n            }));\n            \n            return windowsWithZIndex;\n        },\n\n        // получение конкретного окна по ID пользователя + ID окна\n        async getById(userId, windowId) {\n            if (!userId) throw new Error('User ID required')\n            if (!windowId) throw new Error('Window ID required')\n            \n            const user = await DB.users.get(userId)\n            if (!user) throw new Error(`User with ID ${userId} not found`)\n            \n            const findWindows = user?.systemconfig?.windows || [];\n            let result = null;\n\n            findWindows.forEach(function(val) {\n                if (val.id === windowId) result = val;\n            });\n\n            return result;\n        },\n        \n        // проверка наличия окна по ID пользователя + ID окна\n        async exists(userId, windowId) {\n            if (!userId) throw new Error('User ID required')\n            if (!windowId) throw new Error('Window ID required')\n            \n            try {\n                const window = await this.getById(userId, windowId);\n                return window !== null;\n            } catch {\n                return false;\n            }\n        },\n\n        // возвращает \"следующее\" значение zIndex, которое можно использовать\n        async getCurZIndex(userId) {\n            if (!userId) throw new Error('User ID required');\n\n            let maxZIndex = 100;\n\n            try {\n                const findWindows = await this.windows_getAll(userId);\n\n                if (findWindows && findWindows.length > 0) {\n                    findWindows.forEach(function(value) {\n                        if (value.zIndex > maxZIndex) maxZIndex = value.zIndex;\n                    });\n\n                    return (maxZIndex + 1);\n                } else {\n                    return maxZIndex;\n                }\n            } catch {\n                return maxZIndex;\n            }            \n        },\n\n        // Сохраняем все окна в systemconfig.windows пользователя\n        async saveWindowsToUser(userId) {\n            if (!userId) throw new Error('User ID required');\n\n            try {\n                const user = await DB.users.get(userId);\n                const nWindows = IDBWindows.value.map(w => (new Window(w)));\n                // const nWindows = IDBWindows.value.map(w => (this.prepareWindowForDB(w)));\n\n                let uSystemconfig = user.systemconfig || Def_userSystemconfig;\n                \n                uSystemconfig.windows = nWindows;\n                uSystemconfig.activeWindowId = activeWindowId.value;\n                \n                // Сохраняем обновленный systemconfig\n                await DB.users.where('id').equals(userId)\n                .modify(user => {\n                    user.systemconfig = uSystemconfig;\n                    user.updatedAt = new Date();\n                });\n                \n                return { success: true, userId };\n            } catch (error) {\n                console.error('Failed to save windows to IDB:', error);\n                throw new Error(`Failed to update user's systemconfig/windows: ${error.message}`);\n            }\n        },\n\n        // активирование окна (поднятие его zIndex)\n        async activate(userId, windowId) {\n            if (!userId) throw new Error('User ID required');\n            if (!windowId) throw new Error('Window ID required');\n\n            try {                \n                // Получаем пользователя\n                const user = await DB.users.get(userId);\n                const windows = user?.systemconfig?.windows || [];\n                \n                // Находим окно\n                const windowIndex = windows.findIndex(w => w.id === windowId);\n\n                if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n                \n                // Если окно свернуто - разворачиваем его\n                if (windows[windowIndex].isMinimized) windows[windowIndex].isMinimized = false;\n                \n                // Находим текущий максимальный zIndex\n                const maxZIndex = Math.max(...windows.map(w => w.zIndex || 100), 100);\n                const newZIndex = maxZIndex + 1;\n                \n                // Обновляем zIndex активируемого окна\n                windows[windowIndex].zIndex = newZIndex;\n\n                // Обновляем конфиг\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig.windows = windows;\n                        user.systemconfig.activeWindowId = windowId;\n                        user.updatedAt = new Date();\n                    });\n\n                // Обновляем реактивную переменную\n                IDBWindows.value = windows;\n                activeWindowId.value = windowId;\n\n                return { success: true };                \n            } catch (error) {\n                console.error('Failed to activate window:', error);\n                throw error;\n            }\n        },\n\n        // поиск \"окна\" в SConfig пользователя по данным приложения\n        async getWindow_byConfig(userId, appData) {\n            if (!userId) throw new Error('User ID required');\n            if (!appData) throw new Error('appData required');\n            \n            try {\n                const FindWindows = await this.windows_getAll(userId);\n                \n                if (FindWindows && FindWindows.length > 0) {\n                    let res = false;\n\n                    FindWindows.forEach(function(val) {\n                        if (appData && appData.name && val.name === appData.name) res = val;\n                    });\n\n                    return res;\n                } else {\n                    return false;\n                }\n            } catch (error) {\n                console.error('Error operation(users; getSConfig_window_byConfig).', error);\n                throw new Error(`Failed: ${error.message}`);\n            }\n        },\n\n        // сворачивание окна\n        async minimize(userId, windowId) {\n            if (!userId) throw new Error('User ID required');\n            if (!windowId) throw new Error('Window ID required');\n\n            try {                \n                // Получаем пользователя\n                const user = await DB.users.get(userId);\n                if (!user) throw new Error(`User with ID ${userId} not found`);\n                \n                const windows = user?.systemconfig?.windows || [];\n                \n                // Находим индекс сворачиваемого окна\n                const windowIndex = windows.findIndex(w => w.id === windowId);\n                \n                if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n                \n                // Устанавливаем isMinimized в true\n                windows[windowIndex].isMinimized = true;\n                \n                // Определяем новое активное окно (окно с максимальным zIndex среди не свернутых)\n                const nonMinimizedWindows = windows.filter(w => !w.isMinimized);\n                let newActiveWindowId = null;\n                \n                if (nonMinimizedWindows.length > 0) {\n                    // Находим окно с максимальным zIndex среди не свернутых\n                    newActiveWindowId = nonMinimizedWindows.reduce((max, w) => \n                        (w.zIndex > max.zIndex) ? w : max\n                    , nonMinimizedWindows[0]).id;\n                }\n                \n                console.log('Window minimized, new active window:', newActiveWindowId);\n                \n                // Обновляем конфиг\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig.windows = windows;\n                        user.systemconfig.activeWindowId = newActiveWindowId;\n                        user.updatedAt = new Date();\n                    });\n                \n                // Обновляем глобальные переменные\n                activeWindowId.value = newActiveWindowId;\n                IDBWindows.value = windows;\n                \n                return { success: true, userId, windowId, newActiveWindowId };\n            } catch (error) {\n                console.error('Failed to minimize window:', error);\n                throw new Error(`Failed to minimize window: ${error.message}`);\n            }\n        },\n        \n        // восстановление окна из свернутого состояния\n        async restore(userId, windowId) {\n            if (!userId) throw new Error('User ID required');\n            if (!windowId) throw new Error('Window ID required');\n\n            try {                \n                // Получаем пользователя\n                const user = await DB.users.get(userId);\n                if (!user) throw new Error(`User with ID ${userId} not found`);\n                \n                const windows = user?.systemconfig?.windows || [];\n                \n                // Находим индекс восстанавливаемого окна\n                const windowIndex = windows.findIndex(w => w.id === windowId);\n                \n                if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n                \n                // Устанавливаем isMinimized в false\n                windows[windowIndex].isMinimized = false;\n                \n                // Получаем текущий максимальный zIndex\n                const maxZIndex = Math.max(...windows.map(w => w.zIndex || 100), 100);\n                const newZIndex = maxZIndex + 1;\n                \n                // Обновляем zIndex восстанавливаемого окна\n                windows[windowIndex].zIndex = newZIndex;\n                \n                console.log('Window restored with zIndex:', newZIndex);\n                \n                // Обновляем конфиг\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig.windows = windows;\n                        user.systemconfig.activeWindowId = windowId;\n                        user.updatedAt = new Date();\n                    });\n                \n                // Обновляем глобальные переменные\n                activeWindowId.value = windowId;\n                IDBWindows.value = windows;\n                \n                return { success: true, userId, windowId, zIndex: newZIndex };\n            } catch (error) {\n                console.error('Failed to restore window:', error);\n                throw new Error(`Failed to restore window: ${error.message}`);\n            }\n        },\n\n        // \"закрытие\" окна у пользователя\n        async close(userId, windowId) {\n            if (!userId) throw new Error('User ID required');\n            if (!windowId) throw new Error('Window ID required');\n\n            try {\n                const FindWindows = await this.windows_getAll(userId);\n                \n                // Фильтруем окна, удаляя закрываемое\n                const resultArray = FindWindows.filter(val => val.id !== windowId);\n\n                // Обновляем реактивную переменную\n                IDBWindows.value = resultArray;\n\n                // Получаем пользователя и обновляем его конфиг\n                const user = await DB.users.get(userId);\n                let uSystemconfig = user.systemconfig || Def_userSystemconfig;\n                \n                // Обновляем windows в конфиге\n                uSystemconfig.windows = resultArray.map(w => new Window(w));\n                // uSystemconfig.windows = resultArray.map(w => this.prepareWindowForDB(w));\n                \n                // Если закрываем активное окно, активируем другое\n                if (uSystemconfig.activeWindowId === windowId) {\n                    if (resultArray.length > 0) {\n                        // Активируем окно с максимальным zIndex\n                        const windowsWithZIndex = resultArray.map(w => ({\n                            ...w,\n                            zIndex: w.zIndex || 100\n                        }));\n                        \n                        const maxZWindow = windowsWithZIndex.reduce((max, w) => \n                            w.zIndex > max.zIndex ? w : max\n                        );\n                        \n                        uSystemconfig.activeWindowId = maxZWindow.id;\n                        activeWindowId.value = maxZWindow.id;\n                    } else {\n                        uSystemconfig.activeWindowId = null;\n                        activeWindowId.value = null;\n                    }\n                }\n\n                // Сохраняем в БД\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig = uSystemconfig;\n                        user.updatedAt = new Date();\n                    });\n\n                // Обновляем nextZIndex\n                if (resultArray.length > 0) {\n                    const maxZ = Math.max(...resultArray.map(w => w.zIndex));\n                    nextZIndex = maxZ + 1;\n                } else {\n                    nextZIndex = 100;\n                }\n\n                return { success: true, userId, windowId };\n            } catch (error) {\n                console.error('Error operation(users; windows.close).', error);\n                throw new Error(`Failed: ${error.message}`);\n            }\n        },\n\n        // фиксирование новых координат окна\n        async updatePosition(userId, windowId, positionx, positiony) {\n            if (!userId) throw new Error('User ID required');\n            if (!windowId) throw new Error('Window ID required');\n            if (positionx === undefined || positiony === undefined) throw new Error('Position coordinates required');\n\n            try {\n                // Получаем пользователя\n                const user = await DB.users.get(userId);\n                if (!user) throw new Error(`User with ID ${userId} not found`);\n                \n                const windows = user?.systemconfig?.windows || [];\n                \n                // Находим индекс окна\n                const windowIndex = windows.findIndex(w => w.id === windowId);\n                \n                if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n                \n                // Обновляем позицию окна\n                windows[windowIndex].positionx = positionx;\n                windows[windowIndex].positiony = positiony;\n                \n                // Обновляем конфиг в БД\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig.windows = windows;\n                        user.updatedAt = new Date();\n                    });\n                \n                // Обновляем реактивную переменную\n                IDBWindows.value = windows;\n                \n                return { \n                    success: true, \n                    userId, \n                    windowId, \n                    positionx, \n                    positiony \n                };\n            } catch (error) {\n                console.error('Error updating window position:', error);\n                throw new Error(`Failed to update window position: ${error.message}`);\n            }\n        },\n\n        async updateSize(userId, windowId, width, height) {\n            if (!userId) throw new Error('User ID required');\n            if (!windowId) throw new Error('Window ID required');\n            if (width === undefined || height === undefined) throw new Error('Width and height required');\n\n            try {\n                // Получаем пользователя\n                const user = await DB.users.get(userId);\n                if (!user) throw new Error(`User with ID ${userId} not found`);\n                \n                const windows = user?.systemconfig?.windows || [];\n                \n                // Находим индекс окна\n                const windowIndex = windows.findIndex(w => w.id === windowId);\n                \n                if (windowIndex === -1) throw new Error(`Window with ID ${windowId} not found`);\n                \n                // Обновляем размеры окна\n                windows[windowIndex].defWidth = width;\n                windows[windowIndex].defHeight = height;\n                \n                // Обновляем конфиг в БД\n                await DB.users.where('id').equals(userId)\n                    .modify(user => {\n                        user.systemconfig.windows = windows;\n                        user.updatedAt = new Date();\n                    });\n                \n                // Обновляем реактивную переменную\n                IDBWindows.value = windows;\n                \n                return { \n                    success: true, \n                    userId, \n                    windowId, \n                    width, \n                    height \n                };\n            } catch (error) {\n                console.error('Error updating window size:', error);\n                throw new Error(`Failed to update window size: ${error.message}`);\n            }\n        },\n    },\n\n    windowsstates: {\n        // получить список всех состояний окон по ID пользователя\n        async getAll(userId) {\n            if (!userId) throw new Error('User ID required');\n            \n            const user = await DB.users.get(userId);\n\n            if (!user) throw new Error(`User with ID ${userId} not found`);\n            \n            const states = user?.windowsstates || [];\n            \n            return states;\n        },\n    },\n};\n\nexport const settingsTable = {\n    // сохранение настройки\n    async save(key, value) {\n        try {\n            const existing = await DB.settings.where('key').equals(key).first();\n\n            if (existing) {\n                await DB.settings.update(existing.id, {\n                    value: value,\n                    updatedAt: new Date(),\n                });\n                return existing.id;\n            } else {\n                return await DB.settings.add(new Setting(key, value));\n            }\n        } catch (error) {\n            console.error('Error operation (settings; save');\n            throw new Error(`Failed to save setting ${key}: ${error.message}`);\n        }\n    },\n\n    // получить настройку\n    async get(key, defaultVal = null) {\n        try {\n            const findSetting = DB.settings.where('key').equals(key).first();\n\n            return findSetting ? findSetting.value : defaultVal;\n        } catch (error) {\n            console.error('Error operation (settings; get');\n            throw new Error(`Failed to get setting ${key}: ${error.message}`);\n        }\n    },\n\n    // удалить настройку\n    async delete(key) {\n        try {\n            const findSetting = await DB.settings.where('key').equals(key).first();\n\n            if (findSetting) {\n                return await DB.settings.delete(findSetting.id);\n            } else {\n                return null;\n            }\n        } catch (error) {\n            console.error('Error operation (settings; delete');\n            throw new Error(`Failed to delete setting ${key}: ${error.message}`);\n        }\n    },\n\n    // получить все настройки\n    async getAll() {\n        try {\n            return await DB.settings.toArray();\n        } catch (error) {\n            console.error('Error operation (settings; getAll');\n            throw new Error(`Failed to get all settings`);\n        }\n    },\n};\n\n\n// -=-=-=-=-=-=-Служебное-=-=-=-=-=-=-\n\n// инициализация БД с тестовыми данными\nexport async function initDatabase() {\n    try {\n        // проверка, пустая ли база\n        const userCount = await usersTable.count();\n\n        if (userCount === 0) {\n            // Загружаем apps асинхронно\n            const defaultAppsList = await getDefaultApps();\n\n            // создание базового пользователя\n            const defaultUser = new User({\n                login: 'user',\n                password: '',\n                apps: defaultAppsList,\n                data: {},\n                config: {\n                    avatar: 'robot.jpg',\n                },\n                systemconfig: {\n                    desktopWallpaper: \"nwall.jpg\"\n                },\n            });\n\n            await usersTable.save(defaultUser);\n            console.log('Default user created.');\n        }\n\n        // инициализация базовых настроек \n        const defaultSettings = [\n            ['theme', 'dark'],\n            ['avatarDefault', 'cat'],\n        ];\n\n        for (const [key, value] of defaultSettings) {\n            const existing = await settingsTable.get(key);\n\n            if (existing === null) {\n                await settingsTable.set(key, value);\n            }\n        }\n\n        console.log('Database initialized successfully');\n        return true;\n    } catch (error) {\n        console.error('Error initializing DB:', error);\n\n        throw error;\n    }    \n}\n\n/**\n * Очистка базы данных (осторожно!)\n */\nexport async function clearDatabase() {\n    try {\n        await Promise.all([\n            DB.users.clear(),\n            DB.settings.clear()\n        ]);\n        console.log('Database cleared');\n    } catch (error) {\n        console.error('Error clearing database:', error);\n        throw error;\n    }\n}\n\n// ==================== МИГРАЦИИ (пример, не факт что рабочий) ====================\n\n// Пример добавления миграции при увеличении версии\n// DB.version(2).stores({\n//     users: '++id, login, password, apps, data, config, systemConfig, createdAt, updatedAt, lastLogin',\n//     settings: '++id, key, value, updatedAt',\n//     sessions: '++id, userId, token, expiresAt, createdAt' // Новая таблица\n// }).upgrade(async (tx) => {\n//     // Добавляем поле lastLogin к существующим пользователям\n//     const users = await tx.users.toArray();\n//     await Promise.all(\n//         users.map(user => \n//             tx.users.update(user.id, { \n//                 lastLogin: null,\n//                 updatedAt: new Date() \n//             })\n//         )\n//     );\n    \n//     console.log('Migration to version 2 completed');\n// });\n\nexport { DB, IDBWindows, activeWindowId };\n\nexport default {\n    DB,\n    User,\n    Window,\n    usersTable,\n    settingsTable,\n    initDatabase,\n    clearDatabase\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}