{"ast":null,"code":"import \"core-js/modules/es.array-buffer.detached.js\";\nimport \"core-js/modules/es.array-buffer.transfer.js\";\nimport \"core-js/modules/es.array-buffer.transfer-to-fixed-length.js\";\nimport \"core-js/modules/es.typed-array.with.js\";\nimport \"core-js/modules/esnext.uint8-array.set-from-base64.js\";\nimport \"core-js/modules/esnext.uint8-array.set-from-hex.js\";\nimport \"core-js/modules/esnext.uint8-array.to-base64.js\";\nimport \"core-js/modules/esnext.uint8-array.to-hex.js\";\nimport * as Token from 'token-types';\nimport { tryParseApeHeader } from '../apev2/APEv2Parser.js';\nimport { FourCcToken } from '../common/FourCC.js';\nimport { BasicParser } from '../common/BasicParser.js';\nimport { BlockHeaderToken, MetadataIdToken } from './WavPackToken.js';\nimport initDebug from 'debug';\nimport { uint8ArrayToHex } from 'uint8array-extras';\nimport { makeUnexpectedFileContentError } from '../ParseError.js';\nconst debug = initDebug('music-metadata:parser:WavPack');\nexport class WavPackContentError extends makeUnexpectedFileContentError('WavPack') {}\n/**\r\n * WavPack Parser\r\n */\nexport class WavPackParser extends BasicParser {\n  constructor() {\n    super(...arguments);\n    this.audioDataSize = 0;\n  }\n  async parse() {\n    this.metadata.setAudioOnly();\n    this.audioDataSize = 0;\n    // First parse all WavPack blocks\n    await this.parseWavPackBlocks();\n    // try to parse APEv2 header\n    return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\n  }\n  async parseWavPackBlocks() {\n    do {\n      const blockId = await this.tokenizer.peekToken(FourCcToken);\n      if (blockId !== 'wvpk') break;\n      const header = await this.tokenizer.readToken(BlockHeaderToken);\n      if (header.BlockID !== 'wvpk') throw new WavPackContentError('Invalid WavPack Block-ID');\n      debug(`WavPack header blockIndex=${header.blockIndex}, len=${BlockHeaderToken.len}`);\n      if (header.blockIndex === 0 && !this.metadata.format.container) {\n        this.metadata.setFormat('container', 'WavPack');\n        this.metadata.setFormat('lossless', !header.flags.isHybrid);\n        // tagTypes: this.type,\n        this.metadata.setFormat('bitsPerSample', header.flags.bitsPerSample);\n        if (!header.flags.isDSD) {\n          // In case isDSD, these values will ne set in ID_DSD_BLOCK\n          this.metadata.setFormat('sampleRate', header.flags.samplingRate);\n          this.metadata.setFormat('duration', header.totalSamples / header.flags.samplingRate);\n        }\n        this.metadata.setFormat('numberOfChannels', header.flags.isMono ? 1 : 2);\n        this.metadata.setFormat('numberOfSamples', header.totalSamples);\n        this.metadata.setFormat('codec', header.flags.isDSD ? 'DSD' : 'PCM');\n      }\n      const ignoreBytes = header.blockSize - (BlockHeaderToken.len - 8);\n      await (header.blockIndex === 0 ? this.parseMetadataSubBlock(header, ignoreBytes) : this.tokenizer.ignore(ignoreBytes));\n      if (header.blockSamples > 0) {\n        this.audioDataSize += header.blockSize; // Count audio data for bit-rate calculation\n      }\n    } while (!this.tokenizer.fileInfo.size || this.tokenizer.fileInfo.size - this.tokenizer.position >= BlockHeaderToken.len);\n    if (this.metadata.format.duration) {\n      this.metadata.setFormat('bitrate', this.audioDataSize * 8 / this.metadata.format.duration);\n    }\n  }\n  /**\r\n   * Ref: http://www.wavpack.com/WavPack5FileFormat.pdf, 3.0 Metadata Sub-blocks\r\n   * @param header Header\r\n   * @param remainingLength Remaining length\r\n   */\n  async parseMetadataSubBlock(header, remainingLength) {\n    let remaining = remainingLength;\n    while (remaining > MetadataIdToken.len) {\n      const id = await this.tokenizer.readToken(MetadataIdToken);\n      const dataSizeInWords = await this.tokenizer.readNumber(id.largeBlock ? Token.UINT24_LE : Token.UINT8);\n      const data = new Uint8Array(dataSizeInWords * 2 - (id.isOddSize ? 1 : 0));\n      await this.tokenizer.readBuffer(data);\n      debug(`Metadata Sub-Blocks functionId=0x${id.functionId.toString(16)}, id.largeBlock=${id.largeBlock},data-size=${data.length}`);\n      switch (id.functionId) {\n        case 0x0:\n          // ID_DUMMY: could be used to pad WavPack blocks\n          break;\n        case 0xe:\n          {\n            // ID_DSD_BLOCK\n            debug('ID_DSD_BLOCK');\n            // https://github.com/dbry/WavPack/issues/71#issuecomment-483094813\n            const mp = 1 << Token.UINT8.get(data, 0);\n            const samplingRate = header.flags.samplingRate * mp * 8; // ToDo: second factor should be read from DSD-metadata block https://github.com/dbry/WavPack/issues/71#issuecomment-483094813\n            if (!header.flags.isDSD) throw new WavPackContentError('Only expect DSD block if DSD-flag is set');\n            this.metadata.setFormat('sampleRate', samplingRate);\n            this.metadata.setFormat('duration', header.totalSamples / samplingRate);\n            break;\n          }\n        case 0x24:\n          // ID_ALT_TRAILER: maybe used to embed original ID3 tag header\n          debug('ID_ALT_TRAILER: trailer for non-wav files');\n          break;\n        case 0x26:\n          // ID_MD5_CHECKSUM\n          this.metadata.setFormat('audioMD5', data);\n          break;\n        case 0x2f:\n          // ID_BLOCK_CHECKSUM\n          debug(`ID_BLOCK_CHECKSUM: checksum=${uint8ArrayToHex(data)}`);\n          break;\n        default:\n          debug(`Ignore unsupported meta-sub-block-id functionId=0x${id.functionId.toString(16)}`);\n          break;\n      }\n      remaining -= MetadataIdToken.len + (id.largeBlock ? Token.UINT24_LE.len : Token.UINT8.len) + dataSizeInWords * 2;\n      debug(`remainingLength=${remaining}`);\n      if (id.isOddSize) this.tokenizer.ignore(1);\n    }\n    if (remaining !== 0) throw new WavPackContentError('metadata-sub-block should fit it remaining length');\n  }\n}","map":{"version":3,"names":["Token","tryParseApeHeader","FourCcToken","BasicParser","BlockHeaderToken","MetadataIdToken","initDebug","uint8ArrayToHex","makeUnexpectedFileContentError","debug","WavPackContentError","WavPackParser","constructor","arguments","audioDataSize","parse","metadata","setAudioOnly","parseWavPackBlocks","tokenizer","options","blockId","peekToken","header","readToken","BlockID","blockIndex","len","format","container","setFormat","flags","isHybrid","bitsPerSample","isDSD","samplingRate","totalSamples","isMono","ignoreBytes","blockSize","parseMetadataSubBlock","ignore","blockSamples","fileInfo","size","position","duration","remainingLength","remaining","id","dataSizeInWords","readNumber","largeBlock","UINT24_LE","UINT8","data","Uint8Array","isOddSize","readBuffer","functionId","toString","length","mp","get"],"sources":["C:/projects/My projects/Vue/osi/node_modules/music-metadata/lib/wavpack/WavPackParser.js"],"sourcesContent":["import * as Token from 'token-types';\r\nimport { tryParseApeHeader } from '../apev2/APEv2Parser.js';\r\nimport { FourCcToken } from '../common/FourCC.js';\r\nimport { BasicParser } from '../common/BasicParser.js';\r\nimport { BlockHeaderToken, MetadataIdToken } from './WavPackToken.js';\r\nimport initDebug from 'debug';\r\nimport { uint8ArrayToHex } from 'uint8array-extras';\r\nimport { makeUnexpectedFileContentError } from '../ParseError.js';\r\nconst debug = initDebug('music-metadata:parser:WavPack');\r\nexport class WavPackContentError extends makeUnexpectedFileContentError('WavPack') {\r\n}\r\n/**\r\n * WavPack Parser\r\n */\r\nexport class WavPackParser extends BasicParser {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.audioDataSize = 0;\r\n    }\r\n    async parse() {\r\n        this.metadata.setAudioOnly();\r\n        this.audioDataSize = 0;\r\n        // First parse all WavPack blocks\r\n        await this.parseWavPackBlocks();\r\n        // try to parse APEv2 header\r\n        return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\r\n    }\r\n    async parseWavPackBlocks() {\r\n        do {\r\n            const blockId = await this.tokenizer.peekToken(FourCcToken);\r\n            if (blockId !== 'wvpk')\r\n                break;\r\n            const header = await this.tokenizer.readToken(BlockHeaderToken);\r\n            if (header.BlockID !== 'wvpk')\r\n                throw new WavPackContentError('Invalid WavPack Block-ID');\r\n            debug(`WavPack header blockIndex=${header.blockIndex}, len=${BlockHeaderToken.len}`);\r\n            if (header.blockIndex === 0 && !this.metadata.format.container) {\r\n                this.metadata.setFormat('container', 'WavPack');\r\n                this.metadata.setFormat('lossless', !header.flags.isHybrid);\r\n                // tagTypes: this.type,\r\n                this.metadata.setFormat('bitsPerSample', header.flags.bitsPerSample);\r\n                if (!header.flags.isDSD) {\r\n                    // In case isDSD, these values will ne set in ID_DSD_BLOCK\r\n                    this.metadata.setFormat('sampleRate', header.flags.samplingRate);\r\n                    this.metadata.setFormat('duration', header.totalSamples / header.flags.samplingRate);\r\n                }\r\n                this.metadata.setFormat('numberOfChannels', header.flags.isMono ? 1 : 2);\r\n                this.metadata.setFormat('numberOfSamples', header.totalSamples);\r\n                this.metadata.setFormat('codec', header.flags.isDSD ? 'DSD' : 'PCM');\r\n            }\r\n            const ignoreBytes = header.blockSize - (BlockHeaderToken.len - 8);\r\n            await (header.blockIndex === 0 ? this.parseMetadataSubBlock(header, ignoreBytes) : this.tokenizer.ignore(ignoreBytes));\r\n            if (header.blockSamples > 0) {\r\n                this.audioDataSize += header.blockSize; // Count audio data for bit-rate calculation\r\n            }\r\n        } while (!this.tokenizer.fileInfo.size || this.tokenizer.fileInfo.size - this.tokenizer.position >= BlockHeaderToken.len);\r\n        if (this.metadata.format.duration) {\r\n            this.metadata.setFormat('bitrate', this.audioDataSize * 8 / this.metadata.format.duration);\r\n        }\r\n    }\r\n    /**\r\n     * Ref: http://www.wavpack.com/WavPack5FileFormat.pdf, 3.0 Metadata Sub-blocks\r\n     * @param header Header\r\n     * @param remainingLength Remaining length\r\n     */\r\n    async parseMetadataSubBlock(header, remainingLength) {\r\n        let remaining = remainingLength;\r\n        while (remaining > MetadataIdToken.len) {\r\n            const id = await this.tokenizer.readToken(MetadataIdToken);\r\n            const dataSizeInWords = await this.tokenizer.readNumber(id.largeBlock ? Token.UINT24_LE : Token.UINT8);\r\n            const data = new Uint8Array(dataSizeInWords * 2 - (id.isOddSize ? 1 : 0));\r\n            await this.tokenizer.readBuffer(data);\r\n            debug(`Metadata Sub-Blocks functionId=0x${id.functionId.toString(16)}, id.largeBlock=${id.largeBlock},data-size=${data.length}`);\r\n            switch (id.functionId) {\r\n                case 0x0: // ID_DUMMY: could be used to pad WavPack blocks\r\n                    break;\r\n                case 0xe: { // ID_DSD_BLOCK\r\n                    debug('ID_DSD_BLOCK');\r\n                    // https://github.com/dbry/WavPack/issues/71#issuecomment-483094813\r\n                    const mp = 1 << Token.UINT8.get(data, 0);\r\n                    const samplingRate = header.flags.samplingRate * mp * 8; // ToDo: second factor should be read from DSD-metadata block https://github.com/dbry/WavPack/issues/71#issuecomment-483094813\r\n                    if (!header.flags.isDSD)\r\n                        throw new WavPackContentError('Only expect DSD block if DSD-flag is set');\r\n                    this.metadata.setFormat('sampleRate', samplingRate);\r\n                    this.metadata.setFormat('duration', header.totalSamples / samplingRate);\r\n                    break;\r\n                }\r\n                case 0x24: // ID_ALT_TRAILER: maybe used to embed original ID3 tag header\r\n                    debug('ID_ALT_TRAILER: trailer for non-wav files');\r\n                    break;\r\n                case 0x26: // ID_MD5_CHECKSUM\r\n                    this.metadata.setFormat('audioMD5', data);\r\n                    break;\r\n                case 0x2f: // ID_BLOCK_CHECKSUM\r\n                    debug(`ID_BLOCK_CHECKSUM: checksum=${uint8ArrayToHex(data)}`);\r\n                    break;\r\n                default:\r\n                    debug(`Ignore unsupported meta-sub-block-id functionId=0x${id.functionId.toString(16)}`);\r\n                    break;\r\n            }\r\n            remaining -= MetadataIdToken.len + (id.largeBlock ? Token.UINT24_LE.len : Token.UINT8.len) + dataSizeInWords * 2;\r\n            debug(`remainingLength=${remaining}`);\r\n            if (id.isOddSize)\r\n                this.tokenizer.ignore(1);\r\n        }\r\n        if (remaining !== 0)\r\n            throw new WavPackContentError('metadata-sub-block should fit it remaining length');\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}