{"ast":null,"code":"import initDebug from 'debug';\nimport * as Flac from '../../flac/FlacToken.js';\nimport { FlacParser } from '../../flac/FlacParser.js';\nimport { FourCcToken } from '../../common/FourCC.js';\nimport { VorbisPictureToken } from '../vorbis/Vorbis.js';\nconst debug = initDebug('music-metadata:parser:ogg:theora');\n/**\r\n * Ref:\r\n * - https://xiph.org/flac/ogg_mapping.html\r\n */\nexport class FlacStream {\n  constructor(metadata, options, tokenizer) {\n    this.durationOnLastPage = false;\n    this.metadata = metadata;\n    this.options = options;\n    this.tokenizer = tokenizer;\n    this.flacParser = new FlacParser(this.metadata, this.tokenizer, options);\n  }\n  /**\r\n   * Vorbis 1 parser\r\n   * @param header Ogg Page Header\r\n   * @param pageData Page data\r\n   */\n  async parsePage(header, pageData) {\n    if (header.headerType.firstPage) {\n      await this.parseFirstPage(header, pageData);\n    }\n  }\n  calculateDuration() {\n    debug('duration calculation not implemented');\n  }\n  /**\r\n   * Parse first Theora Ogg page. the initial identification header packet\r\n   */\n  async parseFirstPage(_header, pageData) {\n    debug('First Ogg/FLAC page');\n    const fourCC = await FourCcToken.get(pageData, 9);\n    if (fourCC.toString() !== 'fLaC') {\n      throw new Error('Invalid FLAC preamble');\n    }\n    const blockHeader = await Flac.BlockHeader.get(pageData, 13);\n    await this.parseDataBlock(blockHeader, pageData.subarray(13 + Flac.BlockHeader.len));\n  }\n  async parseDataBlock(blockHeader, pageData) {\n    debug(`blockHeader type=${blockHeader.type}, length=${blockHeader.length}`);\n    switch (blockHeader.type) {\n      case Flac.BlockType.STREAMINFO:\n        {\n          const streamInfo = Flac.BlockStreamInfo.get(pageData, 0);\n          return this.flacParser.processsStreamInfo(streamInfo);\n        }\n      case Flac.BlockType.PADDING:\n        break;\n      case Flac.BlockType.APPLICATION:\n        break;\n      case Flac.BlockType.SEEKTABLE:\n        break;\n      case Flac.BlockType.VORBIS_COMMENT:\n        return this.flacParser.parseComment(pageData);\n      case Flac.BlockType.PICTURE:\n        if (!this.options.skipCovers) {\n          const picture = new VorbisPictureToken(pageData.length).get(pageData, 0);\n          return this.flacParser.addPictureTag(picture);\n        }\n        break;\n      default:\n        this.metadata.addWarning(`Unknown block type: ${blockHeader.type}`);\n    }\n    // Ignore data block\n    return this.tokenizer.ignore(blockHeader.length).then();\n  }\n  flush() {\n    return Promise.resolve();\n  }\n}","map":{"version":3,"names":["initDebug","Flac","FlacParser","FourCcToken","VorbisPictureToken","debug","FlacStream","constructor","metadata","options","tokenizer","durationOnLastPage","flacParser","parsePage","header","pageData","headerType","firstPage","parseFirstPage","calculateDuration","_header","fourCC","get","toString","Error","blockHeader","BlockHeader","parseDataBlock","subarray","len","type","length","BlockType","STREAMINFO","streamInfo","BlockStreamInfo","processsStreamInfo","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","parseComment","PICTURE","skipCovers","picture","addPictureTag","addWarning","ignore","then","flush","Promise","resolve"],"sources":["C:/projects/My projects/Vue/osi/node_modules/music-metadata/lib/ogg/flac/FlacStream.js"],"sourcesContent":["import initDebug from 'debug';\r\nimport * as Flac from '../../flac/FlacToken.js';\r\nimport { FlacParser } from '../../flac/FlacParser.js';\r\nimport { FourCcToken } from '../../common/FourCC.js';\r\nimport { VorbisPictureToken } from '../vorbis/Vorbis.js';\r\nconst debug = initDebug('music-metadata:parser:ogg:theora');\r\n/**\r\n * Ref:\r\n * - https://xiph.org/flac/ogg_mapping.html\r\n */\r\nexport class FlacStream {\r\n    constructor(metadata, options, tokenizer) {\r\n        this.durationOnLastPage = false;\r\n        this.metadata = metadata;\r\n        this.options = options;\r\n        this.tokenizer = tokenizer;\r\n        this.flacParser = new FlacParser(this.metadata, this.tokenizer, options);\r\n    }\r\n    /**\r\n     * Vorbis 1 parser\r\n     * @param header Ogg Page Header\r\n     * @param pageData Page data\r\n     */\r\n    async parsePage(header, pageData) {\r\n        if (header.headerType.firstPage) {\r\n            await this.parseFirstPage(header, pageData);\r\n        }\r\n    }\r\n    calculateDuration() {\r\n        debug('duration calculation not implemented');\r\n    }\r\n    /**\r\n     * Parse first Theora Ogg page. the initial identification header packet\r\n     */\r\n    async parseFirstPage(_header, pageData) {\r\n        debug('First Ogg/FLAC page');\r\n        const fourCC = await FourCcToken.get(pageData, 9);\r\n        if (fourCC.toString() !== 'fLaC') {\r\n            throw new Error('Invalid FLAC preamble');\r\n        }\r\n        const blockHeader = await Flac.BlockHeader.get(pageData, 13);\r\n        await this.parseDataBlock(blockHeader, pageData.subarray(13 + Flac.BlockHeader.len));\r\n    }\r\n    async parseDataBlock(blockHeader, pageData) {\r\n        debug(`blockHeader type=${blockHeader.type}, length=${blockHeader.length}`);\r\n        switch (blockHeader.type) {\r\n            case Flac.BlockType.STREAMINFO: {\r\n                const streamInfo = Flac.BlockStreamInfo.get(pageData, 0);\r\n                return this.flacParser.processsStreamInfo(streamInfo);\r\n            }\r\n            case Flac.BlockType.PADDING:\r\n                break;\r\n            case Flac.BlockType.APPLICATION:\r\n                break;\r\n            case Flac.BlockType.SEEKTABLE:\r\n                break;\r\n            case Flac.BlockType.VORBIS_COMMENT:\r\n                return this.flacParser.parseComment(pageData);\r\n            case Flac.BlockType.PICTURE:\r\n                if (!this.options.skipCovers) {\r\n                    const picture = new VorbisPictureToken(pageData.length).get(pageData, 0);\r\n                    return this.flacParser.addPictureTag(picture);\r\n                }\r\n                break;\r\n            default:\r\n                this.metadata.addWarning(`Unknown block type: ${blockHeader.type}`);\r\n        }\r\n        // Ignore data block\r\n        return this.tokenizer.ignore(blockHeader.length).then();\r\n    }\r\n    flush() {\r\n        return Promise.resolve();\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}