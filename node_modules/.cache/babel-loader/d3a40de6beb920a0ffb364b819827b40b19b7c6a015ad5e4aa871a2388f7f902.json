{"ast":null,"code":"import { AbortError } from './Errors.js';\nimport { Deferred } from './Deferred.js';\nimport { AbstractStreamReader } from \"./AbstractStreamReader.js\";\n/**\n * Node.js Readable Stream Reader\n * Ref: https://nodejs.org/api/stream.html#readable-streams\n */\nexport class StreamReader extends AbstractStreamReader {\n  constructor(s) {\n    super();\n    this.s = s;\n    /**\n     * Deferred used for postponed read request (as not data is yet available to read)\n     */\n    this.deferred = null;\n    if (!s.read || !s.once) {\n      throw new Error('Expected an instance of stream.Readable');\n    }\n    this.s.once('end', () => {\n      this.endOfStream = true;\n      if (this.deferred) {\n        this.deferred.resolve(0);\n      }\n    });\n    this.s.once('error', err => this.reject(err));\n    this.s.once('close', () => this.abort());\n  }\n  /**\n   * Read chunk from stream\n   * @param buffer Target Uint8Array (or Buffer) to store data read from stream in\n   * @param mayBeLess - If true, may fill the buffer partially\n   * @returns Number of bytes read\n   */\n  async readFromStream(buffer, mayBeLess) {\n    if (buffer.length === 0) return 0;\n    const readBuffer = this.s.read(buffer.length);\n    if (readBuffer) {\n      buffer.set(readBuffer);\n      return readBuffer.length;\n    }\n    const request = {\n      buffer,\n      mayBeLess,\n      deferred: new Deferred()\n    };\n    this.deferred = request.deferred;\n    this.s.once('readable', () => {\n      this.readDeferred(request);\n    });\n    return request.deferred.promise;\n  }\n  /**\n   * Process deferred read request\n   * @param request Deferred read request\n   */\n  readDeferred(request) {\n    const readBuffer = this.s.read(request.buffer.length);\n    if (readBuffer) {\n      request.buffer.set(readBuffer);\n      request.deferred.resolve(readBuffer.length);\n      this.deferred = null;\n    } else {\n      this.s.once('readable', () => {\n        this.readDeferred(request);\n      });\n    }\n  }\n  reject(err) {\n    this.interrupted = true;\n    if (this.deferred) {\n      this.deferred.reject(err);\n      this.deferred = null;\n    }\n  }\n  async abort() {\n    this.reject(new AbortError());\n  }\n  async close() {\n    return this.abort();\n  }\n}","map":{"version":3,"names":["AbortError","Deferred","AbstractStreamReader","StreamReader","constructor","s","deferred","read","once","Error","endOfStream","resolve","err","reject","abort","readFromStream","buffer","mayBeLess","length","readBuffer","set","request","readDeferred","promise","interrupted","close"],"sources":["/home/kup/my_projects/vue/osi/node_modules/strtok3/lib/stream/StreamReader.js"],"sourcesContent":["import { AbortError, } from './Errors.js';\nimport { Deferred } from './Deferred.js';\nimport { AbstractStreamReader } from \"./AbstractStreamReader.js\";\n/**\n * Node.js Readable Stream Reader\n * Ref: https://nodejs.org/api/stream.html#readable-streams\n */\nexport class StreamReader extends AbstractStreamReader {\n    constructor(s) {\n        super();\n        this.s = s;\n        /**\n         * Deferred used for postponed read request (as not data is yet available to read)\n         */\n        this.deferred = null;\n        if (!s.read || !s.once) {\n            throw new Error('Expected an instance of stream.Readable');\n        }\n        this.s.once('end', () => {\n            this.endOfStream = true;\n            if (this.deferred) {\n                this.deferred.resolve(0);\n            }\n        });\n        this.s.once('error', err => this.reject(err));\n        this.s.once('close', () => this.abort());\n    }\n    /**\n     * Read chunk from stream\n     * @param buffer Target Uint8Array (or Buffer) to store data read from stream in\n     * @param mayBeLess - If true, may fill the buffer partially\n     * @returns Number of bytes read\n     */\n    async readFromStream(buffer, mayBeLess) {\n        if (buffer.length === 0)\n            return 0;\n        const readBuffer = this.s.read(buffer.length);\n        if (readBuffer) {\n            buffer.set(readBuffer);\n            return readBuffer.length;\n        }\n        const request = {\n            buffer,\n            mayBeLess,\n            deferred: new Deferred()\n        };\n        this.deferred = request.deferred;\n        this.s.once('readable', () => {\n            this.readDeferred(request);\n        });\n        return request.deferred.promise;\n    }\n    /**\n     * Process deferred read request\n     * @param request Deferred read request\n     */\n    readDeferred(request) {\n        const readBuffer = this.s.read(request.buffer.length);\n        if (readBuffer) {\n            request.buffer.set(readBuffer);\n            request.deferred.resolve(readBuffer.length);\n            this.deferred = null;\n        }\n        else {\n            this.s.once('readable', () => {\n                this.readDeferred(request);\n            });\n        }\n    }\n    reject(err) {\n        this.interrupted = true;\n        if (this.deferred) {\n            this.deferred.reject(err);\n            this.deferred = null;\n        }\n    }\n    async abort() {\n        this.reject(new AbortError());\n    }\n    async close() {\n        return this.abort();\n    }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}