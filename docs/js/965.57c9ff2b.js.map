{"version":3,"file":"js/965.57c9ff2b.js","mappings":"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","sources":["webpack://osi/./node_modules/music-metadata/lib/musepack/sv8/StreamVersion8.js","webpack://osi/./node_modules/music-metadata/lib/musepack/MusepackConentError.js","webpack://osi/./node_modules/music-metadata/lib/musepack/sv8/MpcSv8Parser.js","webpack://osi/./node_modules/music-metadata/lib/musepack/sv7/BitReader.js","webpack://osi/./node_modules/music-metadata/lib/musepack/sv7/StreamVersion7.js","webpack://osi/./node_modules/music-metadata/lib/musepack/sv7/MpcSv7Parser.js","webpack://osi/./node_modules/music-metadata/lib/musepack/MusepackParser.js","webpack://osi/./node_modules/music-metadata/lib/id3v2/AbstractID3Parser.js"],"sourcesContent":["import * as Token from 'token-types';\r\nimport initDebug from 'debug';\r\nimport * as util from '../../common/Util.js';\r\nconst debug = initDebug('music-metadata:parser:musepack:sv8');\r\nconst PacketKey = new Token.StringType(2, 'latin1');\r\n/**\r\n * Stream Header Packet part 1\r\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\r\n */\r\nconst SH_part1 = {\r\n    len: 5,\r\n    get: (buf, off) => {\r\n        return {\r\n            crc: Token.UINT32_LE.get(buf, off),\r\n            streamVersion: Token.UINT8.get(buf, off + 4)\r\n        };\r\n    }\r\n};\r\n/**\r\n * Stream Header Packet part 3\r\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\r\n */\r\nconst SH_part3 = {\r\n    len: 2,\r\n    get: (buf, off) => {\r\n        return {\r\n            sampleFrequency: [44100, 48000, 37800, 32000][util.getBitAllignedNumber(buf, off, 0, 3)],\r\n            maxUsedBands: util.getBitAllignedNumber(buf, off, 3, 5),\r\n            channelCount: util.getBitAllignedNumber(buf, off + 1, 0, 4) + 1,\r\n            msUsed: util.isBitSet(buf, off + 1, 4),\r\n            audioBlockFrames: util.getBitAllignedNumber(buf, off + 1, 5, 3)\r\n        };\r\n    }\r\n};\r\nexport class StreamReader {\r\n    get tokenizer() {\r\n        return this._tokenizer;\r\n    }\r\n    set tokenizer(value) {\r\n        this._tokenizer = value;\r\n    }\r\n    constructor(_tokenizer) {\r\n        this._tokenizer = _tokenizer;\r\n    }\r\n    async readPacketHeader() {\r\n        const key = await this.tokenizer.readToken(PacketKey);\r\n        const size = await this.readVariableSizeField();\r\n        return {\r\n            key,\r\n            payloadLength: size.value - 2 - size.len\r\n        };\r\n    }\r\n    async readStreamHeader(size) {\r\n        const streamHeader = {};\r\n        debug(`Reading SH at offset=${this.tokenizer.position}`);\r\n        const part1 = await this.tokenizer.readToken(SH_part1);\r\n        size -= SH_part1.len;\r\n        Object.assign(streamHeader, part1);\r\n        debug(`SH.streamVersion = ${part1.streamVersion}`);\r\n        const sampleCount = await this.readVariableSizeField();\r\n        size -= sampleCount.len;\r\n        streamHeader.sampleCount = sampleCount.value;\r\n        const bs = await this.readVariableSizeField();\r\n        size -= bs.len;\r\n        streamHeader.beginningOfSilence = bs.value;\r\n        const part3 = await this.tokenizer.readToken(SH_part3);\r\n        size -= SH_part3.len;\r\n        Object.assign(streamHeader, part3);\r\n        // assert.equal(size, 0);\r\n        await this.tokenizer.ignore(size);\r\n        return streamHeader;\r\n    }\r\n    async readVariableSizeField(len = 1, hb = 0) {\r\n        let n = await this.tokenizer.readNumber(Token.UINT8);\r\n        if ((n & 0x80) === 0) {\r\n            return { len, value: hb + n };\r\n        }\r\n        n &= 0x7F;\r\n        n += hb;\r\n        return this.readVariableSizeField(len + 1, n << 7);\r\n    }\r\n}\r\n","import { makeUnexpectedFileContentError } from '../ParseError.js';\r\nexport class MusepackContentError extends makeUnexpectedFileContentError('Musepack') {\r\n}\r\n","import initDebug from 'debug';\r\nimport { BasicParser } from '../../common/BasicParser.js';\r\nimport { tryParseApeHeader } from '../../apev2/APEv2Parser.js';\r\nimport { FourCcToken } from '../../common/FourCC.js';\r\nimport * as SV8 from './StreamVersion8.js';\r\nimport { MusepackContentError } from '../MusepackConentError.js';\r\nconst debug = initDebug('music-metadata:parser:musepack');\r\nexport class MpcSv8Parser extends BasicParser {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.audioLength = 0;\r\n    }\r\n    async parse() {\r\n        const signature = await this.tokenizer.readToken(FourCcToken);\r\n        if (signature !== 'MPCK')\r\n            throw new MusepackContentError('Invalid Magic number');\r\n        this.metadata.setFormat('container', 'Musepack, SV8');\r\n        return this.parsePacket();\r\n    }\r\n    async parsePacket() {\r\n        const sv8reader = new SV8.StreamReader(this.tokenizer);\r\n        do {\r\n            const header = await sv8reader.readPacketHeader();\r\n            debug(`packet-header key=${header.key}, payloadLength=${header.payloadLength}`);\r\n            switch (header.key) {\r\n                case 'SH': { // Stream Header\r\n                    const sh = await sv8reader.readStreamHeader(header.payloadLength);\r\n                    this.metadata.setFormat('numberOfSamples', sh.sampleCount);\r\n                    this.metadata.setFormat('sampleRate', sh.sampleFrequency);\r\n                    this.metadata.setFormat('duration', sh.sampleCount / sh.sampleFrequency);\r\n                    this.metadata.setFormat('numberOfChannels', sh.channelCount);\r\n                    break;\r\n                }\r\n                case 'AP': // Audio Packet\r\n                    this.audioLength += header.payloadLength;\r\n                    await this.tokenizer.ignore(header.payloadLength);\r\n                    break;\r\n                case 'RG': // Replaygain\r\n                case 'EI': // Encoder Info\r\n                case 'SO': // Seek Table Offset\r\n                case 'ST': // Seek Table\r\n                case 'CT': // Chapter-Tag\r\n                    await this.tokenizer.ignore(header.payloadLength);\r\n                    break;\r\n                case 'SE': // Stream End\r\n                    if (this.metadata.format.duration) {\r\n                        this.metadata.setFormat('bitrate', this.audioLength * 8 / this.metadata.format.duration);\r\n                    }\r\n                    return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\r\n                default:\r\n                    throw new MusepackContentError(`Unexpected header: ${header.key}`);\r\n            }\r\n            // biome-ignore lint/correctness/noConstantCondition: break is handled in the switch statement\r\n        } while (true);\r\n    }\r\n}\r\n","import * as Token from 'token-types';\r\nexport class BitReader {\r\n    constructor(tokenizer) {\r\n        this.pos = 0;\r\n        this.dword = null;\r\n        this.tokenizer = tokenizer;\r\n    }\r\n    /**\r\n     *\r\n     * @param bits 1..30 bits\r\n     */\r\n    async read(bits) {\r\n        while (this.dword === null) {\r\n            this.dword = await this.tokenizer.readToken(Token.UINT32_LE);\r\n        }\r\n        let out = this.dword;\r\n        this.pos += bits;\r\n        if (this.pos < 32) {\r\n            out >>>= (32 - this.pos);\r\n            return out & ((1 << bits) - 1);\r\n        }\r\n        this.pos -= 32;\r\n        if (this.pos === 0) {\r\n            this.dword = null;\r\n            return out & ((1 << bits) - 1);\r\n        }\r\n        this.dword = await this.tokenizer.readToken(Token.UINT32_LE);\r\n        if (this.pos) {\r\n            out <<= this.pos;\r\n            out |= this.dword >>> (32 - this.pos);\r\n        }\r\n        return out & ((1 << bits) - 1);\r\n    }\r\n    async ignore(bits) {\r\n        if (this.pos > 0) {\r\n            const remaining = 32 - this.pos;\r\n            this.dword = null;\r\n            bits -= remaining;\r\n            this.pos = 0;\r\n        }\r\n        const remainder = bits % 32;\r\n        const numOfWords = (bits - remainder) / 32;\r\n        await this.tokenizer.ignore(numOfWords * 4);\r\n        return this.read(remainder);\r\n    }\r\n}\r\n","import * as Token from 'token-types';\r\nimport * as util from '../../common/Util.js';\r\nimport { textDecode } from '@borewit/text-codec';\r\n/**\r\n * BASIC STRUCTURE\r\n */\r\nexport const Header = {\r\n    len: 6 * 4,\r\n    get: (buf, off) => {\r\n        const header = {\r\n            // word 0\r\n            signature: textDecode(buf.subarray(off, off + 3), 'latin1'),\r\n            // versionIndex number * 1000 (3.81 = 3810) (remember that 4-byte alignment causes this to take 4-bytes)\r\n            streamMinorVersion: util.getBitAllignedNumber(buf, off + 3, 0, 4),\r\n            streamMajorVersion: util.getBitAllignedNumber(buf, off + 3, 4, 4),\r\n            // word 1\r\n            frameCount: Token.UINT32_LE.get(buf, off + 4),\r\n            // word 2\r\n            maxLevel: Token.UINT16_LE.get(buf, off + 8),\r\n            sampleFrequency: [44100, 48000, 37800, 32000][util.getBitAllignedNumber(buf, off + 10, 0, 2)],\r\n            link: util.getBitAllignedNumber(buf, off + 10, 2, 2),\r\n            profile: util.getBitAllignedNumber(buf, off + 10, 4, 4),\r\n            maxBand: util.getBitAllignedNumber(buf, off + 11, 0, 6),\r\n            intensityStereo: util.isBitSet(buf, off + 11, 6),\r\n            midSideStereo: util.isBitSet(buf, off + 11, 7),\r\n            // word 3\r\n            titlePeak: Token.UINT16_LE.get(buf, off + 12),\r\n            titleGain: Token.UINT16_LE.get(buf, off + 14),\r\n            // word 4\r\n            albumPeak: Token.UINT16_LE.get(buf, off + 16),\r\n            albumGain: Token.UINT16_LE.get(buf, off + 18),\r\n            // word\r\n            lastFrameLength: (Token.UINT32_LE.get(buf, off + 20) >>> 20) & 0x7FF,\r\n            trueGapless: util.isBitSet(buf, off + 23, 0)\r\n        };\r\n        header.lastFrameLength = header.trueGapless ? (Token.UINT32_LE.get(buf, 20) >>> 20) & 0x7FF : 0;\r\n        return header;\r\n    }\r\n};\r\n","import initDebug from 'debug';\r\nimport { BasicParser } from '../../common/BasicParser.js';\r\nimport { tryParseApeHeader } from '../../apev2/APEv2Parser.js';\r\nimport { BitReader } from './BitReader.js';\r\nimport * as SV7 from './StreamVersion7.js';\r\nimport { MusepackContentError } from '../MusepackConentError.js';\r\nconst debug = initDebug('music-metadata:parser:musepack');\r\nexport class MpcSv7Parser extends BasicParser {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.bitreader = null;\r\n        this.audioLength = 0;\r\n        this.duration = null;\r\n    }\r\n    async parse() {\r\n        const header = await this.tokenizer.readToken(SV7.Header);\r\n        if (header.signature !== 'MP+')\r\n            throw new MusepackContentError('Unexpected magic number');\r\n        debug(`stream-version=${header.streamMajorVersion}.${header.streamMinorVersion}`);\r\n        this.metadata.setFormat('container', 'Musepack, SV7');\r\n        this.metadata.setFormat('sampleRate', header.sampleFrequency);\r\n        const numberOfSamples = 1152 * (header.frameCount - 1) + header.lastFrameLength;\r\n        this.metadata.setFormat('numberOfSamples', numberOfSamples);\r\n        this.duration = numberOfSamples / header.sampleFrequency;\r\n        this.metadata.setFormat('duration', this.duration);\r\n        this.bitreader = new BitReader(this.tokenizer);\r\n        this.metadata.setFormat('numberOfChannels', header.midSideStereo || header.intensityStereo ? 2 : 1);\r\n        const version = await this.bitreader.read(8);\r\n        this.metadata.setFormat('codec', (version / 100).toFixed(2));\r\n        await this.skipAudioData(header.frameCount);\r\n        debug(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`);\r\n        return tryParseApeHeader(this.metadata, this.tokenizer, this.options);\r\n    }\r\n    async skipAudioData(frameCount) {\r\n        while (frameCount-- > 0) {\r\n            const frameLength = await this.bitreader.read(20);\r\n            this.audioLength += 20 + frameLength;\r\n            await this.bitreader.ignore(frameLength);\r\n        }\r\n        // last frame\r\n        const lastFrameLength = await this.bitreader.read(11);\r\n        this.audioLength += lastFrameLength;\r\n        if (this.duration !== null) {\r\n            this.metadata.setFormat('bitrate', this.audioLength / this.duration);\r\n        }\r\n    }\r\n}\r\n","import initDebug from 'debug';\r\nimport * as Token from 'token-types';\r\nimport { AbstractID3Parser } from '../id3v2/AbstractID3Parser.js';\r\nimport { MpcSv8Parser } from './sv8/MpcSv8Parser.js';\r\nimport { MpcSv7Parser } from './sv7/MpcSv7Parser.js';\r\nimport { MusepackContentError } from './MusepackConentError.js';\r\nconst debug = initDebug('music-metadata:parser:musepack');\r\nexport class MusepackParser extends AbstractID3Parser {\r\n    async postId3v2Parse() {\r\n        const signature = await this.tokenizer.peekToken(new Token.StringType(3, 'latin1'));\r\n        let mpcParser;\r\n        switch (signature) {\r\n            case 'MP+': {\r\n                debug('Stream-version 7');\r\n                mpcParser = new MpcSv7Parser(this.metadata, this.tokenizer, this.options);\r\n                break;\r\n            }\r\n            case 'MPC': {\r\n                debug('Stream-version 8');\r\n                mpcParser = new MpcSv8Parser(this.metadata, this.tokenizer, this.options);\r\n                break;\r\n            }\r\n            default: {\r\n                throw new MusepackContentError('Invalid signature prefix');\r\n            }\r\n        }\r\n        this.metadata.setAudioOnly();\r\n        return mpcParser.parse();\r\n    }\r\n}\r\n","import { EndOfStreamError } from 'strtok3';\r\nimport initDebug from 'debug';\r\nimport { ID3v2Header } from './ID3v2Token.js';\r\nimport { ID3v2Parser } from './ID3v2Parser.js';\r\nimport { ID3v1Parser } from '../id3v1/ID3v1Parser.js';\r\nimport { BasicParser } from '../common/BasicParser.js';\r\nconst debug = initDebug('music-metadata:parser:ID3');\r\n/**\r\n * Abstract parser which tries take ID3v2 and ID3v1 headers.\r\n */\r\nexport class AbstractID3Parser extends BasicParser {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.id3parser = new ID3v2Parser();\r\n    }\r\n    static async startsWithID3v2Header(tokenizer) {\r\n        return (await tokenizer.peekToken(ID3v2Header)).fileIdentifier === 'ID3';\r\n    }\r\n    async parse() {\r\n        try {\r\n            await this.parseID3v2();\r\n        }\r\n        catch (err) {\r\n            if (err instanceof EndOfStreamError) {\r\n                debug(\"End-of-stream\");\r\n            }\r\n            else {\r\n                throw err;\r\n            }\r\n        }\r\n    }\r\n    finalize() {\r\n        return;\r\n    }\r\n    async parseID3v2() {\r\n        await this.tryReadId3v2Headers();\r\n        debug('End of ID3v2 header, go to MPEG-parser: pos=%s', this.tokenizer.position);\r\n        await this.postId3v2Parse();\r\n        if (this.options.skipPostHeaders && this.metadata.hasAny()) {\r\n            this.finalize();\r\n        }\r\n        else {\r\n            const id3v1parser = new ID3v1Parser(this.metadata, this.tokenizer, this.options);\r\n            await id3v1parser.parse();\r\n            this.finalize();\r\n        }\r\n    }\r\n    async tryReadId3v2Headers() {\r\n        const id3Header = await this.tokenizer.peekToken(ID3v2Header);\r\n        if (id3Header.fileIdentifier === 'ID3') {\r\n            debug('Found ID3v2 header, pos=%s', this.tokenizer.position);\r\n            await this.id3parser.parse(this.metadata, this.tokenizer, this.options);\r\n            return this.tryReadId3v2Headers();\r\n        }\r\n    }\r\n}\r\n"],"names":["debug","initDebug","PacketKey","Token","SH_part1","len","get","buf","off","crc","streamVersion","SH_part3","sampleFrequency","util","maxUsedBands","channelCount","msUsed","audioBlockFrames","StreamReader","tokenizer","this","_tokenizer","value","constructor","readPacketHeader","key","readToken","size","readVariableSizeField","payloadLength","readStreamHeader","streamHeader","position","part1","Object","assign","sampleCount","bs","beginningOfSilence","part3","ignore","hb","n","readNumber","MusepackContentError","makeUnexpectedFileContentError","MpcSv8Parser","BasicParser","super","arguments","audioLength","parse","signature","FourCcToken","metadata","setFormat","parsePacket","sv8reader","SV8","header","sh","format","duration","tryParseApeHeader","options","BitReader","pos","dword","read","bits","out","remaining","remainder","numOfWords","Header","textDecode","subarray","streamMinorVersion","streamMajorVersion","frameCount","maxLevel","link","profile","maxBand","intensityStereo","midSideStereo","titlePeak","titleGain","albumPeak","albumGain","lastFrameLength","trueGapless","MpcSv7Parser","bitreader","SV7","numberOfSamples","version","toFixed","skipAudioData","frameLength","MusepackParser","AbstractID3Parser","postId3v2Parse","peekToken","mpcParser","setAudioOnly","id3parser","ID3v2Parser","startsWithID3v2Header","ID3v2Header","fileIdentifier","parseID3v2","err","EndOfStreamError","finalize","tryReadId3v2Headers","skipPostHeaders","hasAny","id3v1parser","ID3v1Parser","id3Header"],"ignoreList":[],"sourceRoot":""}